# Требования к памяти для сервера

## Текущая конфигурация сервера:
- **RAM**: 1 ГБ

## Оценка потребления памяти компонентами:

### Базовое потребление (без нагрузки):
- **PostgreSQL**: ~150-300 МБ
- **Redis**: ~20-50 МБ
- **Django API (Gunicorn, 2 workers)**: ~200-400 МБ
- **Nginx**: ~10-20 МБ
- **Certbot**: ~5-10 МБ
- **Система (OS)**: ~200-300 МБ
- **Резерв**: ~100 МБ

**Итого минимум**: ~685-1180 МБ

### При нагрузке:
- **Импорт Excel (50,000+ строк)**: +200-500 МБ (временное)
- **Обработка данных на карте**: +100-300 МБ
- **Генерация отчетов**: +50-200 МБ
- **Одновременные пользователи**: +50-100 МБ на пользователя

**Итого при нагрузке**: ~1.5-2.5 ГБ

## Вывод:

**1 ГБ может быть недостаточно**, особенно при:
- Импорте больших Excel файлов
- Одновременной работе нескольких пользователей
- Генерации отчетов
- Обработке данных на карте

## Рекомендации:

### Вариант 1: Оптимизация для работы на 1 ГБ (временное решение)

1. **Уменьшить количество Gunicorn workers:**
   ```yaml
   # В api/entrypoint.sh изменить:
   --workers 1  # вместо 2
   ```

2. **Ограничить PostgreSQL:**
   ```yaml
   # В docker-compose.prod.yaml добавить для database:
   environment:
     - POSTGRES_SHARED_BUFFERS=128MB
     - POSTGRES_EFFECTIVE_CACHE_SIZE=256MB
   ```

3. **Оптимизировать Redis:**
   ```yaml
   # Ограничить использование памяти Redis
   command: ["redis-server", "--maxmemory", "100mb", "--maxmemory-policy", "allkeys-lru", ...]
   ```

4. **Использовать swap (если возможно):**
   ```bash
   # Создать swap файл 2 ГБ
   sudo fallocate -l 2G /swapfile
   sudo chmod 600 /swapfile
   sudo mkswap /swapfile
   sudo swapon /swapfile
   ```

### Вариант 2: Увеличить RAM (рекомендуется)

**Рекомендуемый минимум**: 2 ГБ RAM
**Комфортная работа**: 4 ГБ RAM

## Мониторинг использования памяти:

```bash
# Проверка использования памяти контейнерами
docker stats --no-stream

# Проверка общей памяти
free -h

# Проверка использования памяти процессами
ps aux --sort=-%mem | head -10
```

## Признаки нехватки памяти:

- Медленная работа приложения
- Контейнеры перезапускаются (OOM kills)
- Ошибки "Out of memory"
- Медленный импорт Excel
- Таймауты при генерации отчетов

## Рекомендация:

**Для продакшна лучше иметь минимум 2 ГБ RAM**, особенно учитывая:
- Импорт больших Excel файлов (50,000+ строк)
- Одновременную работу пользователей
- Генерацию отчетов с диаграммами
- Обработку данных на карте

Если нет возможности увеличить RAM, используйте оптимизации из Варианта 1.











