<!-- templates/statistics.html -->
<!DOCTYPE html>
{% load static %}
<html>
<head>
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–µ—Ç–æ–≤</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #121212;
            color: #e0e0e0;
            line-height: 1.6;
        }
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .top-nav {
            background: #1f1f1f;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid #333;
        }
        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #bb86fc;
        }
        .nav-links {
            display: flex;
            gap: 20px;
        }
        .nav-links a {
            color: #ccc;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .nav-links a:hover, .nav-links a.active {
            background: #2d2d2d;
            color: #bb86fc;
        }
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        .page-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .page-header h1 {
            font-size: 28px;
            color: #fff;
            margin-bottom: 10px;
        }
        .page-header p {
            color: #aaa;
            font-size: 16px;
        }
        /* –§–∏–ª—å—Ç—Ä—ã */
        .filters-section {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #ccc;
            font-size: 14px;
        }
        .filter-group input, .filter-group select {
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #2d2d2d;
            color: #fff;
            font-size: 14px;
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #bb86fc;
            box-shadow: 0 0 0 2px rgba(187, 134, 252, 0.2);
        }
        .filter-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background: #bb86fc;
            color: #121212;
        }
        .btn-primary:hover {
            background: #d0bcff;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #333;
            color: #fff;
        }
        .btn-secondary:hover {
            background: #444;
            transform: translateY(-2px);
        }
        /* KPI –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .kpi-section {
            margin-bottom: 30px;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .kpi-card {
            background: linear-gradient(135deg, #1e1e1e, #2d2d2d);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid #333;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
            color: #bb86fc;
        }
        .kpi-label {
            font-size: 14px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .kpi-success-rate {
            color: #4caf50; /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è */
        }
        .kpi-effective {
            color: #2196f3;
        }
        /* –ì—Ä–∞—Ñ–∏–∫–∏ */
        .charts-section {
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: #fff;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
        }
        .chart-container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid #333;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .chart-container:hover {
            border-color: #bb86fc;
            box-shadow: 0 6px 20px rgba(187, 134, 252, 0.3);
            transform: translateY(-2px);
        }
        .chart-canvas-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ */
        .chart-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }
        .chart-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chart-modal-content {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            width: 1200px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 2px solid #bb86fc;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .chart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .chart-modal-header h3 {
            margin: 0;
            color: #fff;
            font-size: 24px;
        }
        .chart-modal-close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .chart-modal-close:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }
        .chart-modal-body {
            flex: 1;
            overflow: auto;
        }
        .chart-modal-canvas-wrapper {
            position: relative;
            height: 600px;
            width: 100%;
        }
        /* –¢–∞–±–ª–∏—Ü—ã */
        .tables-section {
            margin-bottom: 30px;
        }
        .table-container {
            background: #1e1e1e;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid #333;
            overflow: hidden;
        }
        .table-header {
            padding: 15px 20px;
            background: #2d2d2d;
            border-bottom: 1px solid #333;
        }
        .table-header h3 {
            font-size: 18px;
            color: #fff;
            margin: 0;
        }
        .table-responsive {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #1e1e1e;
        }
        th {
            background: #2d2d2d;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #ccc;
            border-bottom: 1px solid #333;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            color: #e0e0e0;
        }
        tr:hover {
            background: #2a2a2a;
        }
        .text-success {
            color: #4caf50;
        }
        .text-warning {
            color: #ff9800;
        }
        .text-danger {
            color: #f44336;
        }
        .text-info {
            color: #2196f3;
        }
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
        }
        .modal-content {
            background-color: #1e1e1e;
            margin: 2% auto;
            padding: 0;
            border: 1px solid #333;
            border-radius: 8px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            padding: 20px;
            background: #2d2d2d;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .modal-header h2 {
            margin: 0;
            color: #fff;
            font-size: 24px;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close:hover,
        .close:focus {
            color: #fff;
        }
        .modal-body {
            padding: 20px;
        }
        .pilot-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .pilot-stat-card {
            background: linear-gradient(135deg, #2d2d2d, #1e1e1e);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            text-align: center;
        }
        .pilot-stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #bb86fc;
            margin: 10px 0;
        }
        .pilot-stat-label {
            font-size: 12px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .clickable-pilot {
            color: #bb86fc;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s;
        }
        .clickable-pilot:hover {
            color: #d0bcff;
        }
        .targets-section {
            margin-bottom: 30px;
        }
        .target-item {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #333;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .target-item:hover {
            background: #3a3a3a;
            border-color: #bb86fc;
            transform: translateX(5px);
        }
        .target-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .target-name {
            font-weight: bold;
            color: #fff;
            font-size: 16px;
        }
        .target-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }
        .export-btn {
            background: #4caf50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            margin-left: 10px;
        }
        .export-btn:hover {
            background: #45a049;
        }
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #bb86fc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .filter-actions {
                flex-direction: column;
            }
        }
        @media (max-width: 480px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }
        .map-section {
            margin-bottom: 30px;
        }
        .map-container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid #333;
            height: 500px; /* –ó–∞–¥–∞–π—Ç–µ –∂–µ–ª–∞–µ–º—É—é –≤—ã—Å–æ—Ç—É */
            position: relative;
        }
        #heatmap-map {
            width: 100%;
            height: 100%;
            border-radius: 4px;
            /* border: 1px solid #444; */
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
        .heatmap-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000; /* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ z-index –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã—Å–æ–∫ */
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
            .top-nav {
                padding: 0 10px;
                height: 50px;
            }
            .nav-links {
                position: fixed;
                left: -100%;
                top: 50px;
                flex-direction: column;
                background-color: #1f1f1f;
                width: 100%;
                text-align: center;
                transition: 0.3s;
                box-shadow: 0 10px 27px rgba(0, 0, 0, 0.05);
                z-index: 1000;
                gap: 0;
            }
            .nav-links.active {
                left: 0;
            }
            .nav-links a {
                display: block;
                padding: 15px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            .nav-toggle {
                display: block;
                cursor: pointer;
            }
            .nav-toggle .bar {
                display: block;
                width: 25px;
                height: 3px;
                margin: 5px auto;
                background-color: #ccc;
                transition: 0.3s;
            }
            .nav-toggle.active .bar:nth-child(2) {
                opacity: 0;
            }
            .nav-toggle.active .bar:nth-child(1) {
                transform: translateY(8px) rotate(45deg);
            }
            .nav-toggle.active .bar:nth-child(3) {
                transform: translateY(-8px) rotate(-45deg);
            }

            /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
            .main-content {
                padding: 10px;
            }
            .page-header h1 {
                font-size: 22px;
            }
            .page-header p {
                font-size: 14px;
            }
            .filters-section {
                padding: 15px;
            }
            .filters-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .filter-group label {
                font-size: 13px;
            }
            .filter-group input, .filter-group select {
                padding: 8px;
                font-size: 13px;
            }
            .filter-actions {
                flex-direction: column;
                gap: 10px;
            }
            .btn {
                padding: 10px;
                font-size: 13px;
            }
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            .kpi-card {
                padding: 15px;
            }
            .kpi-value {
                font-size: 24px;
            }
            .kpi-label {
                font-size: 12px;
            }
            .section-title {
                font-size: 18px;
            }
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .chart-container {
                padding: 15px;
            }
            .chart-canvas-wrapper {
                height: 250px;
            }
            .table-header h3 {
                font-size: 16px;
            }
            th, td {
                padding: 8px 10px;
                font-size: 12px;
            }

            .mobile-hide {
                display: none;
            }

            /* –°–∫—Ä—ã—Ç–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
            /* –î–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø–∏–ª–æ—Ç–æ–≤ */
            #pilotsTable .mobile-hide {
                display: none;
            }
            /* –î–ª—è —Ç–∞–±–ª–∏—Ü—ã –¥—Ä–æ–Ω–æ–≤ */
            #dronesTable .mobile-hide {
                display: none;
            }
        }

        @media (min-width: 769px) {
            .nav-toggle {
                display: none;
            }
        }

    </style>
</head>
<body>
    <!-- –í–µ—Ä—Ö–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    {% include 'includes/navigation.html' %}
    <div class="nav-toggle" id="mobile-menu">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
    </div>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content">
        <div class="page-header">
            <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–µ—Ç–æ–≤</h1>
            <p>–ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º</p>
        </div>
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="dateFrom">üìÖ –î–∞—Ç–∞ —Å:</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label for="dateTo">üìÖ –î–∞—Ç–∞ –ø–æ:</label>
                    <input type="date" id="dateTo">
                </div>
                <div class="filter-group">
                    <label for="pilotFilter">üë§ –ü–∏–ª–æ—Ç:</label>
                    <select id="pilotFilter">
                        <option value="">–í—Å–µ –ø–∏–ª–æ—Ç—ã</option>
                        <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </select>
                </div>
                <div class="filter-group">
                    <label for="droneFilter">üöÅ –¢–∏–ø –¥—Ä–æ–Ω–∞:</label>
                    <select id="droneFilter">
                        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                        <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-secondary" id="resetFiltersBtn">‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å</button>
                <button class="btn btn-primary" id="applyFiltersBtn">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
        </div>
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div id="statisticsContent">
            <!-- KPI –ö–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="kpi-section">
                <div class="kpi-grid" id="kpiGrid">
                    <!-- KPI –∫–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
            <div class="charts-section">
                <h2 class="section-title">üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h2>
                <div class="charts-grid">
                    <div class="chart-container" onclick="openChartModal('dailyTrendChart', '–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–ª–µ—Ç–æ–≤ –ø–æ –¥–Ω—è–º')">
                        <h3>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–ª–µ—Ç–æ–≤ –ø–æ –¥–Ω—è–º</h3>
                        <div class="chart-canvas-wrapper">
                            <canvas id="dailyTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container" onclick="openChartModal('pilotsChart', '–£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è –ø–æ –ø–∏–ª–æ—Ç–∞–º')">
                        <h3>–£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è –ø–æ –ø–∏–ª–æ—Ç–∞–º</h3>
                        <div class="chart-canvas-wrapper">
                            <canvas id="pilotsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container" onclick="openChartModal('dronesChart', '–†–∞—Å—Ö–æ–¥ –¥—Ä–æ–Ω–æ–≤')">
                        <h3>–†–∞—Å—Ö–æ–¥ –¥—Ä–æ–Ω–æ–≤</h3>
                        <div class="chart-canvas-wrapper">
                            <canvas id="dronesChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container" onclick="openChartModal('pilotsUsageChart', '–†–∞—Å—Ö–æ–¥ –ø–∏–ª–æ—Ç–æ–≤')">
                        <h3>–†–∞—Å—Ö–æ–¥ –ø–∏–ª–æ—Ç–æ–≤</h3>
                        <div class="chart-canvas-wrapper">
                            <canvas id="pilotsUsageChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container" onclick="openChartModal('targetsChart', '–£–Ω–∏—á—Ç–æ–∂–µ–Ω–Ω—ã–µ —Ü–µ–ª–∏')">
                        <h3>–£–Ω–∏—á—Ç–æ–∂–µ–Ω–Ω—ã–µ —Ü–µ–ª–∏</h3>
                        <div class="chart-canvas-wrapper">
                            <canvas id="targetsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container" onclick="openChartModal('resultsChart', '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ª–µ—Ç–æ–≤')">
                        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ª–µ—Ç–æ–≤</h3>
                        <div class="chart-canvas-wrapper">
                            <canvas id="resultsChart"></canvas>
                        </div>
                    </div>
                </div>
                <!-- –ë–ª–æ–∫ "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ü–µ–ª—è–º" (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–∏–ª–æ—Ç—É) -->
                <div class="chart-container" id="pilotTargetsContainer" style="display: none;">
                    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ü–µ–ª—è–º</h3>
                    <p style="color: #aaa; font-size: 14px; margin-top: 5px; margin-bottom: 15px;">–¶–µ–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–∏–ª–æ—Ç–∞</p>
                    <div class="table-responsive" style="margin-top: 20px;">
                        <table id="pilotTargetsTable">
                            <thead>
                                <tr>
                                    <th>–ü–∏–ª–æ—Ç</th>
                                    <th>–¶–µ–ª—å</th>
                                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–π</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- –¢–∞–±–ª–∏—Ü—ã -->
            <div class="tables-section">
                <h2 class="section-title">üìã –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è</h2>
                <div class="table-container" style="margin-bottom: 25px;">
                    <div class="table-header">
                        <h3>–¢–∞–±–ª–∏—Ü–∞ –ø–∏–ª–æ—Ç–æ–≤</h3>
                    </div>
                    <div class="table-responsive">
                        <table id="pilotsTable">
                            <thead>
                                <tr>
                                    <th>–ü–∏–ª–æ—Ç</th>
                                    <th>–í—Å–µ–≥–æ –≤—ã–ª–µ—Ç–æ–≤</th>
                                    <th>–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ</th>
                                    <th>% –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è</th>
                                    <th>% –£—Å–ø–µ—Ö–∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header">
                        <h3>–¢–∞–±–ª–∏—Ü–∞ —Ç–∏–ø–æ–≤ –¥—Ä–æ–Ω–æ–≤</h3>
                    </div>
                    <div class="table-responsive">
                        <table id="dronesTable">
                            <thead>
                                <tr>
                                    <th>–¢–∏–ø –¥—Ä–æ–Ω–∞</th>
                                    <th>–í—Å–µ–≥–æ –≤—ã–ª–µ—Ç–æ–≤</th>
                                    <th>–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ</th>
                                    <th>% –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è</th>
                                    <th>% –£—Å–ø–µ—Ö–∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ -->
    <div id="chartModal" class="chart-modal">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <h3 id="chartModalTitle">–ì—Ä–∞—Ñ–∏–∫</h3>
                <button class="chart-modal-close" onclick="closeChartModal()">&times;</button>
            </div>
            <div class="chart-modal-body">
                <div class="chart-modal-canvas-wrapper">
                    <canvas id="chartModalCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=5f9b1e6a-a8d8-42e1-8d00-9562515bb9a0&modules=Heatmap"></script>
    <script>
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —á–∞—Ä—Ç–æ–≤
        let dailyTrendChart = null;
        let pilotsChart = null;
        let dronesChart = null; // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
        let pilotsUsageChart = null; // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–∞ –ø–∏–ª–æ—Ç–æ–≤
        let targetsChart = null; // –ì—Ä–∞—Ñ–∏–∫ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π
        let resultsChart = null;
        let modalChart = null; // –ì—Ä–∞—Ñ–∏–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        let heatmapMap = null;
        let heatmapLayer = null;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function fetchStatistics(filters = {}) {
            showLoading(true);
            try {
                const url = new URL('/api/statistics/', window.location.origin);
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                Object.keys(filters).forEach(key => {
                    if (filters[key]) {
                        url.searchParams.append(key, filters[key]);
                    }
                });
                console.log('–ó–∞–ø—Ä–æ—Å –∫ API:', url.toString());
                const response = await fetch(url.toString());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', data);
                // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                updateUI(data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–∏–ª–æ—Ç–æ–≤ –∏ –¥—Ä–æ–Ω–æ–≤ (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤)
        async function fetchFiltersData() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–æ–ª–µ—Ç—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                const flightsResponse = await fetch('/api/flights/');
                const flightsData = await flightsResponse.json();
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–∏–ª–æ—Ç–æ–≤, –∏—Å–∫–ª—é—á–∞—è "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π" –ø–∏–ª–æ—Ç–æ–≤
                const pilots = [...new Set(flightsData.map(f => f.pilot_name).filter(Boolean).filter(p => !p.startsWith('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π_')))].sort();
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥—Ä–æ–Ω–æ–≤
                const droneTypes = [...new Set(flightsData.map(f => f.drone).filter(Boolean))].sort();
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
                const pilotSelect = document.getElementById('pilotFilter');
                const droneSelect = document.getElementById('droneFilter');
                // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏
                pilotSelect.innerHTML = '<option value="">–í—Å–µ –ø–∏–ª–æ—Ç—ã</option>';
                droneSelect.innerHTML = '<option value="">–í—Å–µ —Ç–∏–ø—ã</option>';
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∏–ª–æ—Ç–æ–≤
                pilots.forEach(pilot => {
                    const option = document.createElement('option');
                    option.value = pilot;
                    option.textContent = pilot;
                    pilotSelect.appendChild(option);
                });
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø—ã –¥—Ä–æ–Ω–æ–≤
                droneTypes.forEach(drone => {
                    const option = document.createElement('option');
                    option.value = drone;
                    option.textContent = drone;
                    droneSelect.appendChild(option);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
            }
        }
        function initHeatmapMap() {
            console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã...");
            if (typeof ymaps !== 'undefined' && ymaps.modules && typeof ymaps.modules.require === 'function') {
                try {
                    // –Ø–≤–Ω–æ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å Heatmap
                    const requireResult = ymaps.modules.require(['Heatmap'], function(Heatmap) {
                        try {
                            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
                            heatmapMap = new ymaps.Map("heatmap-map", {
                                center: [55.76, 37.64],
                                zoom: 3,
                                controls: ['zoomControl', 'typeSelector', 'fullscreenControl']
                            });
                            // –°–æ–∑–¥–∞–µ–º —Å–ª–æ–π —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
                            heatmapLayer = new Heatmap([], {
                                radius: 15,
                                dissipating: false,
                                opacity: 0.8,
                                intensityOfMidpoint: 0.5,
                                gradient: {
                                    0.1: 'rgba(128, 255, 0, 0.7)',
                                    0.5: 'rgba(255, 255, 0, 0.8)',
                                    1.0: 'rgba(255, 0, 0, 0.9)'
                                }
                            });
                            heatmapMap.layers.add(heatmapLayer);
                            console.log("–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.");
                        } catch (error) {
                            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:", error);
                            const heatmapElement = document.getElementById('heatmap-map');
                            if (heatmapElement) {
                                heatmapElement.innerHTML = '<p style="color: red; text-align: center;">–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã.</p>';
                            }
                        }
                    });
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ require –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
                    if (requireResult && requireResult.catch) {
                        requireResult.catch(function(error) {
                            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è Heatmap:", error);
                            const heatmapElement = document.getElementById('heatmap-map');
                            if (heatmapElement) {
                                heatmapElement.innerHTML = '<p style="color: red; text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è Heatmap.</p>';
                            }
                        });
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ ymaps.modules.require:", error);
                    const heatmapElement = document.getElementById('heatmap-map');
                    if (heatmapElement) {
                        heatmapElement.innerHTML = '<p style="color: red; text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ API –∫–∞—Ä—Ç.</p>';
                    }
                }
            } else {
                console.warn("Yandex Maps API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.");
                setTimeout(initHeatmapMap, 2000);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –¥–∞–Ω–Ω—ã–º–∏
        function updateHeatmap(heatmapPoints) {
            console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã —Å ${heatmapPoints.length} —Ç–æ—á–∫–∞–º–∏.`);
            if (heatmapLayer && heatmapMap) {
                try {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ API –≤ —Ñ–æ—Ä–º–∞—Ç, –ø–æ–Ω—è—Ç–Ω—ã–π Heatmap
                    // –û–∂–∏–¥–∞–µ–º [{lat: ..., lng: ..., weight: ...}, ...]
                    const heatmapData = heatmapPoints.map(point => [point.lat, point.lng, point.weight || 1]);
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–ª–æ–π
                    heatmapLayer.setData(heatmapData);
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É –ø–æ–¥ —Ç–æ—á–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if (heatmapData.length > 0) {
                        const bounds = heatmapLayer.getBounds();
                        if (bounds) {
                            heatmapMap.setBounds(bounds, {
                                checkZoomRange: true,
                                zoomMargin: [20, 20, 20, 20]
                            });
                        }
                    }
                    console.log("–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.");
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:", error);
                }
            } else {
                console.warn("–°–ª–æ–π —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.");
            }
        }
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            fetchStatistics();
            fetchFiltersData();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É
            initHeatmapMap();
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–°–µ–≥–æ–¥–Ω—è" –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            const todayBtn = document.createElement('button');
            todayBtn.className = 'btn btn-secondary';
            todayBtn.textContent = 'üìÖ –°–µ–≥–æ–¥–Ω—è';
            todayBtn.style.marginLeft = '10px';
            todayBtn.onclick = setTodayPeriod;
            document.querySelector('.filter-actions').insertBefore(todayBtn, document.getElementById('applyFiltersBtn'));
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
            const modal = document.getElementById('chartModal');
            if (modal) {
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeChartModal();
                    }
                });
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∞–≤–∏—à–µ ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal && modal.classList.contains('active')) {
                    closeChartModal();
                }
            });
        });
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        function showLoading(show) {
            const loadingEl = document.getElementById('loadingIndicator');
            const contentEl = document.getElementById('statisticsContent');
            if (show) {
                loadingEl.style.display = 'block';
                contentEl.style.opacity = '0.3';
            } else {
                loadingEl.style.display = 'none';
                contentEl.style.opacity = '1';
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ–≥–æ UI
        function updateUI(data) {
            updateKPI(data.kpi, data.summary);
            updateCharts(data);
            updateTables(data);
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É
            if (data.heatmap_points) {
                updateHeatmap(data.heatmap_points);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è KPI –∫–∞—Ä—Ç–æ—á–µ–∫
        function updateKPI(kpiData, summaryData) {
            const kpiGrid = document.getElementById('kpiGrid');
            // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            kpiGrid.innerHTML = '';
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ KPI
            const kpiCards = [
                {
                    label: '–í—Å–µ–≥–æ –≤—ã–ª–µ—Ç–æ–≤',
                    value: kpiData.total_flights,
                    class: 'kpi-effective'
                },
                {
                    label: '–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ',
                    value: kpiData.destroyed_flights,
                    class: 'kpi-success-rate' // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç
                },
                {
                    label: '–ü—Ä–æ—Ü–µ–Ω—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è',
                    value: kpiData.destruction_rate_percent + '%',
                    class: 'kpi-success-rate' // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç
                },
                {
                    label: '–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞',
                    value: kpiData.success_rate_percent + '%',
                    class: 'kpi-effective' // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω–∏–π —Ü–≤–µ—Ç
                },
                {
                    label: '–°–∞–º—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π',
                    value: summaryData.most_active_pilot || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
                    class: ''
                },
                {
                    label: '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π –¥—Ä–æ–Ω',
                    value: summaryData.most_popular_drone || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
                    class: ''
                }
            ];
            kpiCards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'kpi-card';
                cardEl.innerHTML = `
                    <div class="kpi-label">${card.label}</div>
                    <div class="kpi-value ${card.class}">${card.value}</div>
                `;
                kpiGrid.appendChild(cardEl);
            });
        }
        function updateCharts(data) {
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if (dailyTrendChart) dailyTrendChart.destroy();
            if (pilotsChart) pilotsChart.destroy();
            if (dronesChart) dronesChart.destroy(); // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
            if (pilotsUsageChart && typeof pilotsUsageChart.destroy === 'function') {
                pilotsUsageChart.destroy(); // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–∞ –ø–∏–ª–æ—Ç–æ–≤
            }
            if (targetsChart && typeof targetsChart.destroy === 'function') {
                targetsChart.destroy(); // –ì—Ä–∞—Ñ–∏–∫ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π
            }
            if (resultsChart) resultsChart.destroy();
            // 1. –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –ø–æ –¥–Ω—è–º (–æ–±–Ω–æ–≤–ª–µ–Ω)
            const dailyCtx = document.getElementById('dailyTrendChart').getContext('2d');
            const dates = data.daily_trend.map(d => d.date);
            const totalFlights = data.daily_trend.map(d => d.total_flights);
            const destroyedFlights = data.daily_trend.map(d => d.destroyed_flights);
            const defeatedFlights = data.daily_trend.map(d => d.defeated_flights);
            const notDefeatedFlights = data.daily_trend.map(d => d.not_defeated_flights);
            dailyTrendChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '–í—Å–µ–≥–æ –≤—ã–ª–µ—Ç–æ–≤',
                            data: totalFlights,
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '–ü–æ—Ä–∞–∂–µ–Ω–æ',
                            data: defeatedFlights,
                            borderColor: '#4caf50', // –ó–µ–ª–µ–Ω—ã–π
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ',
                            data: destroyedFlights,
                            borderColor: '#f44336', // –ö—Ä–∞—Å–Ω—ã–π
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#aaa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#aaa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            // 2. –ì—Ä–∞—Ñ–∏–∫ –ø–æ –ø–∏–ª–æ—Ç–∞–º (–æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å—Ç–µ–∫–æ–≤—É—é –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É —Å —Ä–∞–∑–±–∏–≤–∫–æ–π)
            const pilotsCtx = document.getElementById('pilotsChart').getContext('2d');
            const pilotNames = data.pilots.map(p => p.pilot__callname || '–ë–µ–∑ –∏–º–µ–Ω–∏');
            const pilotDestroyed = data.pilots.map(p => p.destroyed_flights || 0);
            const pilotDefeated = data.pilots.map(p => p.defeated_flights || 0);
            const pilotNotDefeated = data.pilots.map(p => p.not_defeated_flights || 0);
            pilotsChart = new Chart(pilotsCtx, {
                type: 'bar',
                data: {
                    labels: pilotNames,
                    datasets: [
                        {
                            label: '–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ',
                            data: pilotDestroyed,
                            backgroundColor: 'rgba(244, 67, 54, 0.8)',
                            borderColor: 'rgba(244, 67, 54, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '–ü–æ—Ä–∞–∂–µ–Ω–æ',
                            data: pilotDefeated,
                            backgroundColor: 'rgba(255, 159, 64, 0.8)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '–í—Å–µ–≥–æ',
                            data: pilotNotDefeated,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                color: '#aaa',
                                autoSkip: false,
                                maxRotation: 90, // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ –≤ 0 –≥—Ä–∞–¥—É—Å–æ–≤ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ)
                                minRotation: 90
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                color: '#aaa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            // 3. –ì—Ä–∞—Ñ–∏–∫ "–†–∞—Å—Ö–æ–¥ –¥—Ä–æ–Ω–æ–≤" (–æ–±–Ω–æ–≤–ª–µ–Ω)
            const dronesCtx = document.getElementById('dronesChart').getContext('2d');
            const droneTypes = data.drones.map(d => d.drone);
            const droneCounts = data.drones.map(d => d.total_flights);

            // –¶–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤
            const backgroundColors = [
                '#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5',
                '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50',
                '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'
            ];

            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (dronesChart) dronesChart.destroy();

            dronesChart = new Chart(dronesCtx, {
                type: 'bar',
                plugins: [ChartDataLabels], // –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–ª–∞–≥–∏–Ω
                data: {
                    labels: droneTypes,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –¥—Ä–æ–Ω–æ–≤',
                        data: droneCounts,
                        backgroundColor: backgroundColors.slice(0, droneTypes.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ª–µ–≥–µ–Ω–¥—É, —Ç–∞–∫ –∫–∞–∫ –º–µ—Ç–∫–∏ –±—É–¥—É—Ç –Ω–∞ —Å—Ç–æ–ª–±—Ü–∞—Ö
                        },
                        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞ datalabels
                        datalabels: {
                            anchor: 'end', // –ü—Ä–∏–≤—è–∑–∫–∞ –º–µ—Ç–∫–∏ –∫ –∫–æ–Ω—Ü—É —Å—Ç–æ–ª–±—Ü–∞
                            align: 'right', // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –º–µ—Ç–∫–∏ —Å–ø—Ä–∞–≤–∞ –æ—Ç –∫–æ–Ω—Ü–∞ —Å—Ç–æ–ª–±—Ü–∞
                            offset: 4, // –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –æ—Ç –∫–æ–Ω—Ü–∞ —Å—Ç–æ–ª–±—Ü–∞
                            color: '#e0e0e0', // –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –º–µ—Ç–∫–∏
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: function(value, context) {
                                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–∞–º–æ –∑–Ω–∞—á–µ–Ω–∏–µ
                                return value;
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: '#aaa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#aaa',
                                autoSkip: false
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            // 4. –ì—Ä–∞—Ñ–∏–∫ "–†–∞—Å—Ö–æ–¥ –ø–∏–ª–æ—Ç–æ–≤" (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å —Ä–∞—Å—Ö–æ–¥–æ–º –¥—Ä–æ–Ω–æ–≤)
            const pilotsUsageCtx = document.getElementById('pilotsUsageChart').getContext('2d');
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–∏–ª–æ—Ç–æ–≤, –∏—Å–∫–ª—é—á–∞—è "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π" –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ —Ç–æ–ø-15 –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const allPilotsForUsage = data.pilots.filter(p => p.pilot__callname && !p.pilot__callname.startsWith('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π_'))
                .sort((a, b) => b.total_flights - a.total_flights)
                .slice(0, 15); // –¢–æ–ø-15 –ø–∏–ª–æ—Ç–æ–≤
            
            const pilotUsageNames = allPilotsForUsage.map(p => p.pilot__callname);
            const pilotUsageCounts = allPilotsForUsage.map(p => p.total_flights);

            // –¶–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ —Ü–≤–µ—Ç–∞)
            const pilotBackgroundColors = [
                '#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5',
                '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50',
                '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'
            ];

            pilotsUsageChart = new Chart(pilotsUsageCtx, {
                type: 'bar',
                plugins: [ChartDataLabels], // –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–ª–∞–≥–∏–Ω
                data: {
                    labels: pilotUsageNames,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ª–µ—Ç–æ–≤',
                        data: pilotUsageCounts,
                        backgroundColor: pilotBackgroundColors.slice(0, pilotUsageNames.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ª–µ–≥–µ–Ω–¥—É, —Ç–∞–∫ –∫–∞–∫ –º–µ—Ç–∫–∏ –±—É–¥—É—Ç –Ω–∞ —Å—Ç–æ–ª–±—Ü–∞—Ö
                        },
                        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞ datalabels
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: function(value) {
                                return value; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —Å—Ç–æ–ª–±—Ü–µ
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: '#aaa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#aaa',
                                autoSkip: false,
                                maxRotation: 0,
                                minRotation: 0
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            // 5. –ì—Ä–∞—Ñ–∏–∫ "–£–Ω–∏—á—Ç–æ–∂–µ–Ω–Ω—ã–µ —Ü–µ–ª–∏" (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å —Ä–∞—Å—Ö–æ–¥–æ–º –ø–∏–ª–æ—Ç–æ–≤)
            const targetsCtx = document.getElementById('targetsChart').getContext('2d');
            const targetNames = data.targets ? data.targets.map(t => t.target || '–ù–µ —É–∫–∞–∑–∞–Ω–∞') : [];
            const targetCounts = data.targets ? data.targets.map(t => t.destroyed_count || 0) : [];

            // –¶–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ —Ü–≤–µ—Ç–∞)
            const targetBackgroundColors = [
                '#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5',
                '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50',
                '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'
            ];

            targetsChart = new Chart(targetsCtx, {
                type: 'bar',
                plugins: [ChartDataLabels], // –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–ª–∞–≥–∏–Ω
                data: {
                    labels: targetNames,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–π',
                        data: targetCounts,
                        backgroundColor: targetBackgroundColors.slice(0, targetNames.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ª–µ–≥–µ–Ω–¥—É, —Ç–∞–∫ –∫–∞–∫ –º–µ—Ç–∫–∏ –±—É–¥—É—Ç –Ω–∞ —Å—Ç–æ–ª–±—Ü–∞—Ö
                        },
                        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞ datalabels
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: function(value) {
                                return value; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —Å—Ç–æ–ª–±—Ü–µ
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: '#aaa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#aaa',
                                autoSkip: false,
                                maxRotation: 0,
                                minRotation: 0
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            // 6. –ì—Ä–∞—Ñ–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã–ª–µ—Ç–æ–≤ (–æ–±–Ω–æ–≤–ª–µ–Ω)
            const resultsCtx = document.getElementById('resultsChart').getContext('2d');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —è–≤–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ API
            const resultLabels = ['destroyed', 'defeated', 'not defeated'];
            const resultValues = [
                data.results_breakdown['destroyed'] || 0,
                data.results_breakdown['defeated'] || 0,
                data.results_breakdown['not defeated'] || 0
            ];
            const readableLabels = ['–£–Ω–∏—á—Ç–æ–∂–µ–Ω', '–ü–æ—Ä–∞–∂–µ–Ω', '–ù–µ –ø–æ—Ä–∞–∂–µ–Ω'];
            // –ù–∞–∑–Ω–∞—á–∞–µ–º —Ü–≤–µ—Ç–∞: –£–Ω–∏—á—Ç–æ–∂–µ–Ω (–ª—É—á—à–∏–π) - –ó–µ–ª–µ–Ω—ã–π, –ü–æ—Ä–∞–∂–µ–Ω - –ñ–µ–ª—Ç—ã–π, –ù–µ –ø–æ—Ä–∞–∂–µ–Ω - –ö—Ä–∞—Å–Ω—ã–π
            const backgroundColorsResults = ['#4caf50', '#ffeb3b', '#f44336'];
            resultsChart = new Chart(resultsCtx, {
                type: 'doughnut',
                data: {
                    labels: readableLabels,
                    datasets: [{
                        data: resultValues,
                        backgroundColor: backgroundColorsResults,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    }
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –≥—Ä–∞—Ñ–∏–∫–æ–º
        function openChartModal(chartId, title) {
            // –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
            let originalChart = null;
            switch(chartId) {
                case 'dailyTrendChart':
                    originalChart = dailyTrendChart;
                    break;
                case 'pilotsChart':
                    originalChart = pilotsChart;
                    break;
                case 'dronesChart':
                    originalChart = dronesChart;
                    break;
                case 'pilotsUsageChart':
                    originalChart = pilotsUsageChart;
                    break;
                case 'targetsChart':
                    originalChart = targetsChart;
                    break;
                case 'resultsChart':
                    originalChart = resultsChart;
                    break;
            }
            
            if (!originalChart) {
                console.error('–≠–∫–∑–µ–º–ø–ª—è—Ä –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω:', chartId);
                return;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('chartModalTitle').textContent = title;
            
            // –ü–æ–ª—É—á–∞–µ–º canvas –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const modalCanvas = document.getElementById('chartModalCanvas');
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (modalChart) {
                modalChart.destroy();
                modalChart = null;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–Ω–∞—á–∞–ª–∞, —á—Ç–æ–±—ã canvas –ø–æ–ª—É—á–∏–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            const modal = document.getElementById('chartModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ø–µ–ª–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è –∏ canvas –ø–æ–ª—É—á–∏–ª —Ä–∞–∑–º–µ—Ä—ã
            setTimeout(() => {
                try {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–µ–Ω –ª–∏ –ø–ª–∞–≥–∏–Ω ChartDataLabels
                    const needsDataLabels = chartId === 'dronesChart' || chartId === 'pilotsUsageChart' || chartId === 'targetsChart';
                    
                    // –ì–ª—É–±–æ–∫–æ –∫–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
                    const chartConfig = {
                        type: originalChart.config.type,
                        data: JSON.parse(JSON.stringify(originalChart.config.data)),
                        options: JSON.parse(JSON.stringify(originalChart.config.options || {}))
                    };
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    chartConfig.options.responsive = true;
                    chartConfig.options.maintainAspectRatio = false;
                    
                    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
                    const newChartConfig = {
                        type: chartConfig.type,
                        data: chartConfig.data,
                        options: chartConfig.options
                    };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≥–∏–Ω—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã
                    if (needsDataLabels) {
                        newChartConfig.plugins = [ChartDataLabels];
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                    modalChart = new Chart(modalCanvas, newChartConfig);
                    
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
                    setTimeout(() => {
                        if (modalChart) {
                            modalChart.resize();
                        }
                    }, 200);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ:', error);
                    console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error.message, error.stack);
                }
            }, 150);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeChartModal() {
            document.getElementById('chartModal').classList.remove('active');
            document.body.style.overflow = ''; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            if (modalChart) {
                modalChart.destroy();
                modalChart = null;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü
        function updateTables(data) {
            // –¢–∞–±–ª–∏—Ü–∞ –ø–∏–ª–æ—Ç–æ–≤
            const pilotsTableBody = document.querySelector('#pilotsTable tbody');
            pilotsTableBody.innerHTML = '';
            data.pilots.forEach(pilot => {
                const row = document.createElement('tr');
                const pilotName = pilot.pilot__callname || '–ë–µ–∑ –∏–º–µ–Ω–∏';
                row.innerHTML = `
                    <td>
                        <span class="clickable-pilot" onclick="openPilotDetail('${pilotName}')">
                            ${pilotName}
                        </span>
                    </td>
                    <td>${pilot.total_flights}</td>
                    <td>${pilot.destroyed_flights || 0}</td>
                    <td class="${pilot.destruction_rate_percent >= 10 ? 'text-success' : pilot.destruction_rate_percent >= 5 ? 'text-warning' : 'text-danger'}">
                        ${pilot.destruction_rate_percent}%
                    </td>
                    <td class="${pilot.success_rate_percent >= 50 ? 'text-success' : pilot.success_rate_percent >= 30 ? 'text-warning' : 'text-danger'}">
                        ${pilot.success_rate_percent || 0}%
                    </td>
                `;
                pilotsTableBody.appendChild(row);
            });
            // –¢–∞–±–ª–∏—Ü–∞ –¥—Ä–æ–Ω–æ–≤
            const dronesTableBody = document.querySelector('#dronesTable tbody');
            dronesTableBody.innerHTML = '';
            data.drones.forEach(drone => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${drone.drone}</td>
                    <td>${drone.total_flights}</td>
                    <td>${drone.destroyed_flights || 0}</td>
                    <td class="${drone.destruction_rate_percent >= 10 ? 'text-success' : drone.destruction_rate_percent >= 5 ? 'text-warning' : 'text-danger'}">
                        ${drone.destruction_rate_percent}%
                    </td>
                    <td class="${drone.success_rate_percent >= 50 ? 'text-success' : drone.success_rate_percent >= 30 ? 'text-warning' : 'text-danger'}">
                        ${drone.success_rate_percent || 0}%
                    </td>
                `;
                dronesTableBody.appendChild(row);
            });
            
            // –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ —Ü–µ–ª—è–º (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–∏–ª–æ—Ç—É)
            const pilotTargetsContainer = document.querySelector('#pilotTargetsContainer');
            const pilotTargetsTableBody = document.querySelector('#pilotTargetsTable tbody');
            const pilotFilterValue = document.getElementById('pilotFilter').value;
            
            if (pilotFilterValue && pilotTargetsTableBody && data.pilot_targets) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–∏–ª–æ—Ç—É
                if (pilotTargetsContainer) {
                    pilotTargetsContainer.style.display = 'block';
                }
                pilotTargetsTableBody.innerHTML = '';
                
                if (data.pilot_targets.length === 0) {
                    pilotTargetsTableBody.innerHTML = '<tr><td colspan="3" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ü–µ–ª—è—Ö</td></tr>';
                } else {
                    data.pilot_targets.forEach(pilotData => {
                        if (pilotData.targets && pilotData.targets.length > 0) {
                            pilotData.targets.forEach((targetData, index) => {
                                const row = document.createElement('tr');
                                // –î–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –∫–∞–∂–¥–æ–≥–æ –ø–∏–ª–æ—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–∏–ª–æ—Ç–∞, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –ø—É—Å—Ç–∞—è —è—á–µ–π–∫–∞
                                const pilotNameCell = index === 0 
                                    ? `<td rowspan="${pilotData.targets.length}" style="vertical-align: top; padding-top: 15px; font-weight: 600; color: #bb86fc;">
                                           <span class="clickable-pilot" onclick="openPilotDetail('${escapeHtml(pilotData.pilot_name)}')">
                                               ${escapeHtml(pilotData.pilot_name)}
                                           </span>
                                       </td>`
                                    : '';
                                
                                row.innerHTML = `
                                    ${pilotNameCell}
                                    <td>${escapeHtml(targetData.target || '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}</td>
                                    <td class="text-center" style="font-weight: 600;">
                                        <span style="color: #4caf50; font-size: 16px;">
                                            ${targetData.destroyed_count}
                                        </span>
                                    </td>
                                `;
                                pilotTargetsTableBody.appendChild(row);
                            });
                        }
                    });
                }
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫, –µ—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–∏–ª–æ—Ç—É –Ω–µ –≤—ã–±—Ä–∞–Ω
                if (pilotTargetsContainer) {
                    pilotTargetsContainer.style.display = 'none';
                }
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyFilters() {
            const filters = {
                date_from: document.getElementById('dateFrom').value,
                date_to: document.getElementById('dateTo').value,
                pilot_callname: document.getElementById('pilotFilter').value,
                drone_type: document.getElementById('droneFilter').value
            };
            console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã:', filters);
            fetchStatistics(filters);
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function resetFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('pilotFilter').value = '';
            document.getElementById('droneFilter').value = '';
            console.log('–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã');
            fetchStatistics(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä–∏–æ–¥–∞ "–°–µ–≥–æ–¥–Ω—è"
        function setTodayPeriod() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
            applyFilters();
        }
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            fetchStatistics();
            fetchFiltersData();
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–°–µ–≥–æ–¥–Ω—è" –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            const todayBtn = document.createElement('button');
            todayBtn.className = 'btn btn-secondary';
            todayBtn.textContent = 'üìÖ –°–µ–≥–æ–¥–Ω—è';
            todayBtn.style.marginLeft = '10px';
            todayBtn.onclick = setTodayPeriod;
            document.querySelector('.filter-actions').insertBefore(todayBtn, document.getElementById('applyFiltersBtn'));
        });

        document.addEventListener('DOMContentLoaded', function() {
            // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            const mobileMenu = document.getElementById('mobile-menu');
            const navLinks = document.querySelector('.nav-links');

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
            if (mobileMenu && navLinks) {
                mobileMenu.addEventListener('click', function() {
                    mobileMenu.classList.toggle('active');
                    navLinks.classList.toggle('active');
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Å—ã–ª–∫—É
                const navItems = navLinks.querySelectorAll('a');
                navItems.forEach(item => {
                    item.addEventListener('click', () => {
                        mobileMenu.classList.remove('active');
                        navLinks.classList.remove('active');
                    });
                });
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    if (mobileMenu && navLinks) {
                        mobileMenu.classList.remove('active');
                        navLinks.classList.remove('active');
                    }
                }
            });
        });

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∏–ª–æ—Ç–µ
        let pilotDetailModal = null;
        let pilotDetailData = null;
        let pilotDetailChart = null;
        let targetDetailModal = null;

        function openPilotDetail(pilotCallname) {
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
            if (!pilotDetailModal) {
                createPilotDetailModal();
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            pilotDetailModal.style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∏–ª–æ—Ç–∞
            loadPilotDetail(pilotCallname);
        }

        function createPilotDetailModal() {
            pilotDetailModal = document.createElement('div');
            pilotDetailModal.className = 'modal';
            pilotDetailModal.id = 'pilotDetailModal';
            pilotDetailModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="pilotDetailTitle">–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–∏–ª–æ—Ç–∞</h2>
                        <button class="close" onclick="closePilotDetail()">&times;</button>
                    </div>
                    <div class="modal-body" id="pilotDetailBody">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–∏–ª–æ—Ç–∞...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(pilotDetailModal);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            pilotDetailModal.addEventListener('click', function(e) {
                if (e.target === pilotDetailModal) {
                    closePilotDetail();
                }
            });
        }

        function closePilotDetail() {
            if (pilotDetailModal) {
                pilotDetailModal.style.display = 'none';
            }
            if (pilotDetailChart) {
                pilotDetailChart.destroy();
                pilotDetailChart = null;
            }
        }

        async function loadPilotDetail(pilotCallname) {
            try {
                const response = await fetch(`/api/pilot_detail/?pilot_callname=${encodeURIComponent(pilotCallname)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                pilotDetailData = data;
                renderPilotDetail(data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–∏–ª–æ—Ç–∞:', error);
                document.getElementById('pilotDetailBody').innerHTML = `
                    <div style="color: #f44336; text-align: center; padding: 40px;">
                        <p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: ${error.message}</p>
                    </div>
                `;
            }
        }

        function renderPilotDetail(data) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∏–ª–æ—Ç–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
            pilotDetailData = data;
            
            const body = document.getElementById('pilotDetailBody');
            const title = document.getElementById('pilotDetailTitle');
            title.textContent = `–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–∏–ª–æ—Ç–∞: ${data.pilot.callname}`;
            
            const stats = data.statistics;
            
            body.innerHTML = `
                <div class="pilot-stats-grid">
                    <div class="pilot-stat-card">
                        <div class="pilot-stat-label">–í—Å–µ–≥–æ –≤—ã–ª–µ—Ç–æ–≤</div>
                        <div class="pilot-stat-value">${stats.total_flights}</div>
                    </div>
                    <div class="pilot-stat-card">
                        <div class="pilot-stat-label">–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ</div>
                        <div class="pilot-stat-value" style="color: #4caf50;">${stats.destroyed_flights}</div>
                    </div>
                    <div class="pilot-stat-card">
                        <div class="pilot-stat-label">–ü–æ—Ä–∞–∂–µ–Ω–æ</div>
                        <div class="pilot-stat-value" style="color: #ff9800;">${stats.defeated_flights}</div>
                    </div>
                    <div class="pilot-stat-card">
                        <div class="pilot-stat-label">% –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è</div>
                        <div class="pilot-stat-value" style="color: #bb86fc;">${stats.destruction_rate}%</div>
                    </div>
                    <div class="pilot-stat-card">
                        <div class="pilot-stat-label">% –£—Å–ø–µ—Ö–∞</div>
                        <div class="pilot-stat-value" style="color: #2196f3;">${stats.success_rate || 0}%</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px; text-align: right;">
                    <button class="export-btn" onclick="exportPilotToExcel()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                </div>
                
                <div class="targets-section">
                    <h3 class="section-title">–í—ã–ª–µ—Ç—ã –ø–æ —Ü–µ–ª—è–º</h3>
                    <div id="targetsList"></div>
                </div>
                
                <div class="charts-section">
                    <h3 class="section-title">–î–∏–Ω–∞–º–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –¥–∞—Ç–∞–º</h3>
                    <div class="chart-container">
                        <div class="chart-canvas-wrapper">
                            <canvas id="pilotDetailChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –≤—ã–ª–µ—Ç—ã –ø–æ —Ü–µ–ª—è–º
            renderFlightsByTarget(data.flights_by_target);
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä–∞—Ñ–∏–∫
            renderPilotDetailChart(data.daily_trend);
        }

        function renderFlightsByTarget(targetsData) {
            const targetsList = document.getElementById('targetsList');
            targetsList.innerHTML = '';
            
            if (targetsData.length === 0) {
                targetsList.innerHTML = '<p style="color: #aaa; text-align: center; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—ã–ª–µ—Ç–∞—Ö –ø–æ —Ü–µ–ª—è–º</p>';
                return;
            }
            
            targetsData.forEach(target => {
                const targetItem = document.createElement('div');
                targetItem.className = 'target-item';
                targetItem.setAttribute('data-target-name', target.target);
                targetItem.innerHTML = `
                    <div class="target-header">
                        <div class="target-name">${target.target}</div>
                        <div class="target-stats">
                            <span style="color: #4caf50;">–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ: ${target.destroyed}</span>
                            <span style="color: #ff9800;">–ü–æ—Ä–∞–∂–µ–Ω–æ: ${target.defeated}</span>
                            <span style="color: #aaa;">–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ: ${target.not_defeated}</span>
                            <span style="color: #bb86fc;">–í—Å–µ–≥–æ: ${target.total}</span>
                            <span style="color: #2196f3;">% –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è: ${target.destruction_rate}%</span>
                        </div>
                    </div>
                `;
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                targetItem.addEventListener('click', function() {
                    showTargetDetail(target.target);
                });
                targetsList.appendChild(targetItem);
            });
        }
        
        function showTargetDetail(targetName) {
            if (!pilotDetailData || !pilotDetailData.flights) {
                console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª–µ—Ç–∞—Ö –ø–∏–ª–æ—Ç–∞');
                return;
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–ª–µ—Ç—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏
            const targetFlights = pilotDetailData.flights.filter(flight => {
                const flightTarget = flight.target || '–ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ü–µ–ª–∏';
                return flightTarget === targetName || (targetName === '–ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ü–µ–ª–∏' && !flight.target);
            });
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
            if (!targetDetailModal) {
                createTargetDetailModal();
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            targetDetailModal.style.display = 'block';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            renderTargetDetailContent(targetName, targetFlights);
        }
        
        function createTargetDetailModal() {
            targetDetailModal = document.createElement('div');
            targetDetailModal.className = 'modal';
            targetDetailModal.id = 'targetDetailModal';
            targetDetailModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="targetDetailTitle">–î–µ—Ç–∞–ª–∏ –ø–æ —Ü–µ–ª–∏</h2>
                        <button class="close" onclick="closeTargetDetail()">&times;</button>
                    </div>
                    <div class="modal-body" id="targetDetailBody">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(targetDetailModal);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            targetDetailModal.addEventListener('click', function(e) {
                if (e.target === targetDetailModal) {
                    closeTargetDetail();
                }
            });
        }
        
        function closeTargetDetail() {
            if (targetDetailModal) {
                targetDetailModal.style.display = 'none';
            }
        }
        
        function renderTargetDetailContent(targetName, flights) {
            const title = document.getElementById('targetDetailTitle');
            const body = document.getElementById('targetDetailBody');
            
            title.textContent = `–í—ã–ª–µ—Ç—ã –ø–æ —Ü–µ–ª–∏: ${targetName}`;
            
            if (flights.length === 0) {
                body.innerHTML = '<p style="color: #aaa; text-align: center; padding: 40px;">–ù–µ—Ç –≤—ã–ª–µ—Ç–æ–≤ –ø–æ –¥–∞–Ω–Ω–æ–π —Ü–µ–ª–∏</p>';
                return;
            }
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–µ–ª–∏
            const total = flights.length;
            const destroyed = flights.filter(f => f.result === 'destroyed').length;
            const defeated = flights.filter(f => f.result === 'defeated').length;
            const notDefeated = flights.filter(f => f.result === 'not defeated').length;
            const destructionRate = total > 0 ? ((destroyed / total) * 100).toFixed(2) : 0;
            
            let html = `
                <div class="pilot-stats-grid" style="margin-bottom: 30px;">
                    <div class="pilot-stat-card">
                        <div class="pilot-stat-label">–í—Å–µ–≥–æ –≤—ã–ª–µ—Ç–æ–≤</div>
                        <div class="pilot-stat-value">${total}</div>
                    </div>
                    <div class="pilot-stat-card">
                        <div class="pilot-stat-label">–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ</div>
                        <div class="pilot-stat-value" style="color: #4caf50;">${destroyed}</div>
                    </div>
                    <div class="pilot-stat-card">
                        <div class="pilot-stat-label">–ü–æ—Ä–∞–∂–µ–Ω–æ</div>
                        <div class="pilot-stat-value" style="color: #ff9800;">${defeated}</div>
                    </div>
                    <div class="pilot-stat-card">
                        <div class="pilot-stat-label">–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ</div>
                        <div class="pilot-stat-value" style="color: #aaa;">${notDefeated}</div>
                    </div>
                    <div class="pilot-stat-card">
                        <div class="pilot-stat-label">% –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è</div>
                        <div class="pilot-stat-value" style="color: #bb86fc;">${destructionRate}%</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>–°–ø–∏—Å–æ–∫ –≤—ã–ª–µ—Ç–æ–≤ (${total})</h3>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>‚Ññ</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–í—Ä–µ–º—è</th>
                                    <th>–î—Ä–æ–Ω</th>
                                    <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                    <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            flights.forEach((flight, index) => {
                const resultText = {
                    'destroyed': '<span style="color: #4caf50;">‚úì –£–Ω–∏—á—Ç–æ–∂–µ–Ω</span>',
                    'defeated': '<span style="color: #ff9800;">‚ö† –ü–æ—Ä–∞–∂–µ–Ω</span>',
                    'not defeated': '<span style="color: #aaa;">‚óã –ù–µ –ø–æ—Ä–∞–∂–µ–Ω</span>'
                }[flight.result] || flight.result || '';
                
                const date = flight.flight_date ? new Date(flight.flight_date).toLocaleDateString('ru-RU') : '';
                const time = flight.flight_time ? flight.flight_time.substring(0, 5) : '';
                
                html += `
                    <tr>
                        <td>${flight.number || index + 1}</td>
                        <td>${date}</td>
                        <td>${time}</td>
                        <td>${flight.drone || '-'}</td>
                        <td>${resultText}</td>
                        <td>${flight.coordinates || '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${(flight.comment || '').replace(/"/g, '&quot;')}">${flight.comment || '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            body.innerHTML = html;
        }

        function renderPilotDetailChart(dailyTrend) {
            const ctx = document.getElementById('pilotDetailChart').getContext('2d');
            
            if (pilotDetailChart) {
                pilotDetailChart.destroy();
            }
            
            const dates = dailyTrend.map(d => d.date);
            const destroyed = dailyTrend.map(d => d.destroyed_flights || 0);
            const defeated = dailyTrend.map(d => d.defeated_flights || 0);
            const notDefeated = dailyTrend.map(d => d.not_defeated_flights || 0);
            const total = dailyTrend.map(d => d.total_flights || 0);
            
            pilotDetailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '–í—Å–µ–≥–æ –≤—ã–ª–µ—Ç–æ–≤',
                            data: total,
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ',
                            data: destroyed,
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '–ü–æ—Ä–∞–∂–µ–Ω–æ',
                            data: defeated,
                            borderColor: '#ff9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ',
                            data: notDefeated,
                            borderColor: '#f44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#aaa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#aaa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function exportPilotToExcel() {
            if (!pilotDetailData) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            const pilot = pilotDetailData.pilot;
            const pilotCallname = encodeURIComponent(pilot.callname);
            
            // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ API endpoint
            const url = `/api/pilot_export/excel/?pilot_callname=${pilotCallname}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = `pilot_${pilot.callname}_${new Date().toISOString().split('T')[0]}.xlsx`;
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>