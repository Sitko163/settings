<!DOCTYPE html>
{% load static %}
<html>
<head>
    <title>–û—Ç—á–µ—Ç—ã</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #121212;
            color: #e0e0e0;
            line-height: 1.6;
        }
        .top-nav {
            background: #1f1f1f;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid #333;
        }
        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #bb86fc;
        }
        .nav-links {
            display: flex;
            gap: 20px;
        }
        .nav-links a {
            color: #ccc;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .nav-links a:hover, .nav-links a.active {
            background: #2d2d2d;
            color: #bb86fc;
        }
        .main-content {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        .page-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .page-header h1 {
            font-size: 28px;
            color: #bb86fc;
        }
        .filters-panel {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .filters-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #bb86fc;
        }
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            margin-bottom: 5px;
            color: #aaa;
            font-size: 12px;
        }
        .filter-group input,
        .filter-group select {
            padding: 8px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }
        .filter-group select[multiple] {
            min-height: 100px;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #6200ee;
            color: white;
        }
        .btn-primary:hover {
            background: #7c3aed;
        }
        .btn-success {
            background: #03dac6;
            color: #000;
        }
        .btn-success:hover {
            background: #18ffff;
        }
        .btn-danger {
            background: #b00020;
            color: white;
        }
        .btn-danger:hover {
            background: #cf6679;
        }
        .btn-secondary {
            background: #444;
            color: white;
        }
        .btn-secondary:hover {
            background: #555;
        }
        .report-content {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .report-section {
            margin-bottom: 30px;
        }
        .report-section h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #bb86fc;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .stat-card .label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #bb86fc;
        }
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #2d2d2d;
        }
        table th {
            background: #366092;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        table td {
            padding: 10px 12px;
            border-bottom: 1px solid #444;
        }
        table tr:hover {
            background: #333;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    {% include 'includes/navigation.html' %}
    
    <div class="main-content">
        <div class="page-header">
            <h1>üìä –û—Ç—á–µ—Ç—ã</h1>
            <div class="export-buttons">
                <button class="btn btn-success" onclick="exportToExcel()" id="exportExcelBtn" disabled>
                    üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                </button>
            </div>
        </div>

        <div class="filters-panel">
            <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
            <div class="filter-row">
                <div class="filter-group">
                    <label>–î–∞—Ç–∞ —Å:</label>
                    <input type="date" id="dateFrom" />
                </div>
                <div class="filter-group">
                    <label>–î–∞—Ç–∞ –ø–æ:</label>
                    <input type="date" id="dateTo" />
                </div>
                <div class="filter-group">
                    <label>–ü–∏–ª–æ—Ç—ã:</label>
                    <input type="text" id="pilotsSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–∏–ª–æ—Ç–æ–≤..." style="width: 100%; padding: 6px; margin-bottom: 5px; background: #2d2d2d; border: 1px solid #444; color: #e0e0e0; border-radius: 3px; font-size: 13px;" oninput="filterSelectOptions('pilotsFilter', this.value)">
                    <select id="pilotsFilter" multiple style="max-height: 150px;" onchange="onPilotChange()">
                        <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </select>
                </div>
                <div class="filter-group" id="targetsFilterGroup" style="display: none;">
                    <label>–¢–∏–ø—ã —Ü–µ–ª–µ–π:</label>
                    <input type="text" id="targetsSearch" placeholder="üîç –ü–æ–∏—Å–∫ —Ü–µ–ª–µ–π..." style="width: 100%; padding: 6px; margin-bottom: 5px; background: #2d2d2d; border: 1px solid #444; color: #e0e0e0; border-radius: 3px; font-size: 13px;" oninput="filterSelectOptions('targetsFilter', this.value)">
                    <select id="targetsFilter" multiple style="max-height: 150px;" onchange="onTargetChange()">
                        <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </select>
                </div>
                <div class="filter-group" id="dronesFilterGroup" style="display: none;">
                    <label>–¢–∏–ø—ã –¥—Ä–æ–Ω–æ–≤:</label>
                    <input type="text" id="dronesSearch" placeholder="üîç –ü–æ–∏—Å–∫ –¥—Ä–æ–Ω–æ–≤..." style="width: 100%; padding: 6px; margin-bottom: 5px; background: #2d2d2d; border: 1px solid #444; color: #e0e0e0; border-radius: 3px; font-size: 13px;" oninput="filterSelectOptions('dronesFilter', this.value)">
                    <select id="dronesFilter" multiple style="max-height: 150px;" onchange="onDroneChange()">
                        <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </select>
                </div>
                <div class="filter-group" id="resultsFilterGroup" style="display: none;">
                    <label>–†–µ–∑—É–ª—å—Ç–∞—Ç:</label>
                    <input type="text" id="resultsSearch" placeholder="üîç –ü–æ–∏—Å–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..." style="width: 100%; padding: 6px; margin-bottom: 5px; background: #2d2d2d; border: 1px solid #444; color: #e0e0e0; border-radius: 3px; font-size: 13px;" oninput="filterSelectOptions('resultsFilter', this.value)">
                    <select id="resultsFilter" multiple style="max-height: 150px;">
                        <option value="destroyed">–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ</option>
                        <option value="defeated">–ü–æ—Ä–∞–∂–µ–Ω–æ</option>
                        <option value="not defeated">–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ</option>
                    </select>
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn btn-primary" onclick="loadReport()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                <button class="btn btn-secondary" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>

        <div id="reportContent" class="report-content">
            <div class="loading" style="padding: 20px; text-align: center;">
                <h3 style="color: #03dac6; margin-bottom: 15px;">üìä –û—Ç—á–µ—Ç—ã</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã" –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞</p>
            </div>
        </div>
    </div>

    <script>
        let currentReportData = null;
        let currentFilters = {};
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ–ø—Ü–∏–π –≤ select –ø–æ —Ç–µ–∫—Å—Ç—É –ø–æ–∏—Å–∫–∞
        function filterSelectOptions(selectId, searchText) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const searchLower = searchText.toLowerCase().trim();
            const options = select.querySelectorAll('option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (!searchLower || text.includes(searchLower)) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –¢–û–õ–¨–ö–û –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ (–∫–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
        function normalizeTargetName(targetName) {
            if (!targetName) return '–Ω–µ —É–∫–∞–∑–∞–Ω–∞';
            const targetStr = String(targetName).trim();
            if (!targetStr) return '–Ω–µ —É–∫–∞–∑–∞–Ω–∞';
            // –ü—Ä–æ—Å—Ç–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–µ–ª–æ–≤
            const targetNormalized = targetStr.toLowerCase().replace(/\s+/g, ' ').trim();
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º "–ù–µ —É–∫–∞–∑–∞–Ω–æ", "–ù–µ —É–∫–∞–∑–∞–Ω–∞" –∏ —Ç.–¥.
            if (['–Ω–µ —É–∫–∞–∑–∞–Ω–æ', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞', '–Ω–µ—É–∫–∞–∑–∞–Ω–æ', '–Ω–µ—É–∫–∞–∑–∞–Ω–∞', 'none', 'null', ''].includes(targetNormalized)) {
                return '–Ω–µ —É–∫–∞–∑–∞–Ω–∞';
            }
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –ø–æ—Ö–æ–∂–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–ª—é—á–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏)
            if (targetNormalized.includes('–∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω') || targetNormalized.includes('–∞–≤—Ç–æ—Ç–µ—Ö–Ω–∏–∫') || 
                targetNormalized.includes('–∞–≤—Ç–æ —Ç–µ—Ö–Ω–∏–∫') || targetNormalized.includes('–∞–≤—Ç–æ-—Ç–µ—Ö–Ω–∏–∫')) {
                return '–∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞';
            }
            if (targetNormalized.includes('–ø–≤—Ö')) {
                const match = targetNormalized.match(/–ø–≤—Ö\s*[-]?\s*(\d+[–∏]?)/i);
                if (match) {
                    return `–ø–≤—Ö-${match[1].toLowerCase()}`;
                }
                return '–ø–≤—Ö';
            }
            
            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –ø—Ä–æ—Å—Ç–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ —Ä–µ–≥–∏—Å—Ç—Ä –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            return targetNormalized;
        }
        
        function normalizeDroneName(droneName) {
            if (!droneName) return '–Ω–µ —É–∫–∞–∑–∞–Ω';
            const droneStr = String(droneName).trim();
            if (!droneStr) return '–Ω–µ —É–∫–∞–∑–∞–Ω';
            // –ü—Ä–æ—Å—Ç–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–µ–ª–æ–≤
            const droneNormalized = droneStr.toLowerCase().replace(/\s+/g, ' ').trim();
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º "–ù–µ —É–∫–∞–∑–∞–Ω–æ", "–ù–µ —É–∫–∞–∑–∞–Ω" –∏ —Ç.–¥.
            if (['–Ω–µ —É–∫–∞–∑–∞–Ω–æ', '–Ω–µ —É–∫–∞–∑–∞–Ω', '–Ω–µ—É–∫–∞–∑–∞–Ω–æ', '–Ω–µ—É–∫–∞–∑–∞–Ω', 'none', 'null', ''].includes(droneNormalized)) {
                return '–Ω–µ —É–∫–∞–∑–∞–Ω';
            }
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –ø–æ—Ö–æ–∂–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–ª—é—á–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏)
            if (droneNormalized.includes('–ø–≤—Ö')) {
                const match = droneNormalized.match(/–ø–≤—Ö\s*[-]?\s*(\d+[–∏]?)/i);
                if (match) {
                    return `–ø–≤—Ö-${match[1].toLowerCase()}`;
                }
                return '–ø–≤—Ö';
            }
            if (droneNormalized.includes('–º–æ–ª–Ω–∏—è')) {
                const match = droneNormalized.match(/–º–æ–ª–Ω–∏—è\s*[-]?\s*(\d+[–¥—Ç]?)/i);
                if (match) {
                    return `–º–æ–ª–Ω–∏—è-${match[1].toLowerCase()}`;
                }
                return '–º–æ–ª–Ω–∏—è';
            }
            // –ö–í–ù - –∏—â–µ–º –ö–í–ù —Å –Ω–æ–º–µ—Ä–æ–º –∏–ª–∏ –±—É–∫–≤–æ–π (–ö–í–ù-–¢, –ö–í–ù-23, –ö–í–ù-23–¢ –∏ —Ç.–¥.)
            if (droneNormalized.includes('–∫–≤–Ω')) {
                const match = droneNormalized.match(/–∫–≤–Ω\s*[-]?\s*(\d+[—Ç—Ç]?|[—Ç—Ç]|\d+)/i);
                if (match) {
                    return `–∫–≤–Ω-${match[1].toLowerCase()}`;
                }
                return '–∫–≤–Ω';
            }
            
            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - —É–¥–∞–ª—è–µ–º –¥–µ—Ñ–∏—Å—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, —á—Ç–æ–±—ã X-51 –∏ X51 —Å—á–∏—Ç–∞–ª–∏—Å—å –æ–¥–Ω–∏–º
            const droneWithoutDash = droneNormalized.replace(/-/g, '');
            return droneWithoutDash;
        }

        // –ö–∞—Å–∫–∞–¥–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Ñ–∏–ª—å—Ç—Ä —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
        async function loadFilters() {
            try {
                const pilotsSelect = document.getElementById('pilotsFilter');
                pilotsSelect.innerHTML = '';
                
                const response = await fetch('/api/filters/');
                const data = await response.json();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∏–ª—å—Ç—Ä—ã –ø–∏–ª–æ—Ç–æ–≤
                data.pilots.forEach(pilot => {
                    const option = document.createElement('option');
                    option.value = pilot.id;
                    option.textContent = pilot.callname;
                    pilotsSelect.appendChild(option);
                });
                
                // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                document.getElementById('targetsFilterGroup').style.display = 'none';
                document.getElementById('dronesFilterGroup').style.display = 'none';
                document.getElementById('resultsFilterGroup').style.display = 'none';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
            }
        }
        
        async function onPilotChange() {
            const pilotsSelect = document.getElementById('pilotsFilter');
            const selectedPilotIds = Array.from(pilotsSelect.selectedOptions).map(o => o.value);
            
            // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö
            document.getElementById('targetsFilter').selectedIndex = -1;
            document.getElementById('dronesFilter').selectedIndex = -1;
            document.getElementById('resultsFilter').selectedIndex = -1;
            
            if (selectedPilotIds.length === 0) {
                // –ï—Å–ª–∏ –ø–∏–ª–æ—Ç—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã, —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                document.getElementById('targetsFilterGroup').style.display = 'none';
                document.getElementById('dronesFilterGroup').style.display = 'none';
                document.getElementById('resultsFilterGroup').style.display = 'none';
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∏–ª–æ—Ç–æ–≤
                const params = new URLSearchParams();
                selectedPilotIds.forEach(id => params.append('pilot_id', id));
                
                const response = await fetch(`/api/filters/?${params.toString()}`);
                const data = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ü–µ–ª–µ–π
                updateTargetsFilter(data.targets || []);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Ü–µ–ª–µ–π, —Å–∫—Ä—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
                document.getElementById('targetsFilterGroup').style.display = 'flex';
                document.getElementById('dronesFilterGroup').style.display = 'none';
                document.getElementById('resultsFilterGroup').style.display = 'none';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ü–µ–ª–µ–π:', error);
            }
        }
        
        async function onTargetChange() {
            const pilotsSelect = document.getElementById('pilotsFilter');
            const targetsSelect = document.getElementById('targetsFilter');
            const selectedPilotIds = Array.from(pilotsSelect.selectedOptions).map(o => o.value);
            const selectedTargets = Array.from(targetsSelect.selectedOptions).map(o => o.value);
            
            // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö
            document.getElementById('dronesFilter').selectedIndex = -1;
            document.getElementById('resultsFilter').selectedIndex = -1;
            
            if (selectedPilotIds.length === 0 || selectedTargets.length === 0) {
                // –ï—Å–ª–∏ –ø–∏–ª–æ—Ç—ã –∏–ª–∏ —Ü–µ–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã, —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                document.getElementById('dronesFilterGroup').style.display = 'none';
                document.getElementById('resultsFilterGroup').style.display = 'none';
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥—Ä–æ–Ω—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∏–ª–æ—Ç–æ–≤ –∏ —Ü–µ–ª–µ–π
                const params = new URLSearchParams();
                selectedPilotIds.forEach(id => params.append('pilot_id', id));
                selectedTargets.forEach(t => params.append('target_type', t));
                
                const response = await fetch(`/api/filters/?${params.toString()}`);
                const data = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –¥—Ä–æ–Ω–æ–≤
                updateDronesFilter(data.drones || []);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –¥—Ä–æ–Ω–æ–≤, —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                document.getElementById('dronesFilterGroup').style.display = 'flex';
                document.getElementById('resultsFilterGroup').style.display = 'none';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥—Ä–æ–Ω–æ–≤:', error);
            }
        }
        
        async function onDroneChange() {
            const pilotsSelect = document.getElementById('pilotsFilter');
            const targetsSelect = document.getElementById('targetsFilter');
            const dronesSelect = document.getElementById('dronesFilter');
            const selectedPilotIds = Array.from(pilotsSelect.selectedOptions).map(o => o.value);
            const selectedTargets = Array.from(targetsSelect.selectedOptions).map(o => o.value);
            const selectedDrones = Array.from(dronesSelect.selectedOptions).map(o => o.value);
            
            // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ–º —Ñ–∏–ª—å—Ç—Ä–µ
            document.getElementById('resultsFilter').selectedIndex = -1;
            
            if (selectedPilotIds.length === 0 || selectedTargets.length === 0 || selectedDrones.length === 0) {
                // –ï—Å–ª–∏ –≤—Å–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                document.getElementById('resultsFilterGroup').style.display = 'none';
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∏–ª–æ—Ç–æ–≤, —Ü–µ–ª–µ–π –∏ –¥—Ä–æ–Ω–æ–≤
                const params = new URLSearchParams();
                selectedPilotIds.forEach(id => params.append('pilot_id', id));
                selectedTargets.forEach(t => params.append('target_type', t));
                selectedDrones.forEach(d => params.append('drone_type', d));
                
                const response = await fetch(`/api/filters/?${params.toString()}`);
                const data = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                updateResultsFilter(data.results || []);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                document.getElementById('resultsFilterGroup').style.display = 'flex';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', error);
            }
        }
        
        function updateTargetsFilter(targets) {
            const targetsSelect = document.getElementById('targetsFilter');
            const normalizedTargets = new Set();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const selectedValues = Array.from(targetsSelect.selectedOptions).map(o => o.value);
            
            targetsSelect.innerHTML = '';
            
            targets.forEach(target => {
                const normalizedKey = normalizeTargetName(target);
                if (!normalizedTargets.has(normalizedKey)) {
                    normalizedTargets.add(normalizedKey);
                    const option = document.createElement('option');
                    option.value = target;
                    option.textContent = target;
                    if (selectedValues.includes(target)) {
                        option.selected = true;
                    }
                    targetsSelect.appendChild(option);
                }
            });
        }
        
        function updateDronesFilter(drones) {
            const dronesSelect = document.getElementById('dronesFilter');
            const normalizedDrones = new Set();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const selectedValues = Array.from(dronesSelect.selectedOptions).map(o => o.value);
            
            dronesSelect.innerHTML = '';
            
            drones.forEach(drone => {
                const normalizedKey = normalizeDroneName(drone);
                if (!normalizedDrones.has(normalizedKey)) {
                    normalizedDrones.add(normalizedKey);
                    const option = document.createElement('option');
                    option.value = drone;
                    option.textContent = drone;
                    if (selectedValues.includes(drone)) {
                        option.selected = true;
                    }
                    dronesSelect.appendChild(option);
                }
            });
        }
        
        function updateResultsFilter(results) {
            const resultsSelect = document.getElementById('resultsFilter');
            const selectedValues = Array.from(resultsSelect.selectedOptions).map(o => o.value);
            
            // –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            const resultMapping = {
                'destroyed': '–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ',
                'defeated': '–ü–æ—Ä–∞–∂–µ–Ω–æ',
                'not defeated': '–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ',
                'not_defeated': '–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ'  // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
            };
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
            const normalizedResults = new Set();
            if (results && results.length > 0) {
                results.forEach(result => {
                    if (!result) return;
                    
                    const resultLower = String(result).trim().toLowerCase();
                    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º
                    if (resultLower.includes('destroyed') || resultLower.includes('—É–Ω–∏—á—Ç–æ–∂–µ–Ω')) {
                        normalizedResults.add('destroyed');
                    } else if (resultLower.includes('defeated') || resultLower.includes('–ø–æ—Ä–∞–∂–µ–Ω')) {
                        normalizedResults.add('defeated');
                    } else if (resultLower.includes('not') || resultLower.includes('–Ω–µ –ø–æ—Ä–∞–∂–µ–Ω') || resultLower.includes('–ø—Ä–æ–º–∞—Ö')) {
                        normalizedResults.add('not defeated');
                    } else if (resultLower === 'destroyed') {
                        normalizedResults.add('destroyed');
                    } else if (resultLower === 'defeated') {
                        normalizedResults.add('defeated');
                    } else if (resultLower === 'not defeated' || resultLower === 'not_defeated') {
                        normalizedResults.add('not defeated');
                    }
                });
            }
            
            resultsSelect.innerHTML = '';
            
            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const orderedResults = ['destroyed', 'defeated', 'not defeated'];
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            orderedResults.forEach(result => {
                if (normalizedResults.has(result) || normalizedResults.size === 0) {
                    const option = document.createElement('option');
                    option.value = result;
                    option.textContent = resultMapping[result] || result;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±—Ä–∞–Ω (—Å —É—á–µ—Ç–æ–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏)
                    if (selectedValues.includes(result) || 
                        (result === 'not defeated' && (selectedValues.includes('not_defeated') || selectedValues.includes('not defeated')))) {
                        option.selected = true;
                    }
                    resultsSelect.appendChild(option);
                }
            });
        }

        async function loadReport() {
            const reportContent = document.getElementById('reportContent');
            reportContent.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';
            
            // –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            const filters = {
                date_from: document.getElementById('dateFrom').value || null,
                date_to: document.getElementById('dateTo').value || null,
                pilot_id: Array.from(document.getElementById('pilotsFilter').selectedOptions).map(o => o.value),
                target_type: Array.from(document.getElementById('targetsFilter').selectedOptions).map(o => o.value),
                drone_type: Array.from(document.getElementById('dronesFilter').selectedOptions).map(o => o.value),
                result: Array.from(document.getElementById('resultsFilter').selectedOptions).map(o => o.value),
            };
            
            currentFilters = filters;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const params = new URLSearchParams();
            if (filters.date_from) params.append('date_from', filters.date_from);
            if (filters.date_to) params.append('date_to', filters.date_to);
            filters.pilot_id.forEach(id => params.append('pilot_id', id));
            filters.target_type.forEach(t => params.append('target_type', t));
            filters.drone_type.forEach(d => params.append('drone_type', d));
            filters.result.forEach(r => params.append('result', r));
            
            try {
                const response = await fetch(`/api/reports/data/?${params.toString()}`);
                const data = await response.json();
                currentReportData = data;
                
                renderReport(data);
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
                document.getElementById('exportExcelBtn').disabled = false;
            } catch (error) {
                reportContent.innerHTML = `<div class="loading" style="color: #b00020;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}</div>`;
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞:', error);
            }
        }

        function renderReport(data) {
            const reportContent = document.getElementById('reportContent');
            console.log('=== –†–ï–ù–î–ï–†–ò–ú –û–¢–ß–ï–¢ (–≤–µ—Ä—Å–∏—è 2.0) ===');
            console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π:', {
                pilots: data.pilots.length,
                targets: data.targets.length,
                drones: data.drones ? data.drones.length : 0
            });
            console.log('–ü—Ä–∏–º–µ—Ä —Ü–µ–ª–µ–π:', data.targets.slice(0, 5).map(t => t.target));
            console.log('–ü—Ä–∏–º–µ—Ä –¥—Ä–æ–Ω–æ–≤:', data.drones ? data.drones.slice(0, 5).map(d => d.drone) : []);
            let html = '';
            
            // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            html += '<div class="report-section">';
            html += '<h3>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>';
            html += '<div class="stats-grid">';
            html += `<div class="stat-card"><div class="label">–í—Å–µ–≥–æ –≤—ã–ª–µ—Ç–æ–≤</div><div class="value">${data.summary.total_flights}</div></div>`;
            html += `<div class="stat-card"><div class="label">–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ</div><div class="value">${data.summary.destroyed_flights}</div></div>`;
            html += `<div class="stat-card"><div class="label">–ü–æ—Ä–∞–∂–µ–Ω–æ</div><div class="value">${data.summary.defeated_flights}</div></div>`;
            html += `<div class="stat-card"><div class="label">–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ</div><div class="value">${data.summary.not_defeated_flights}</div></div>`;
            html += `<div class="stat-card"><div class="label">% –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è</div><div class="value">${data.summary.destruction_rate_percent}%</div></div>`;
            html += `<div class="stat-card"><div class="label">% –£—Å–ø–µ—Ö–∞</div><div class="value">${data.summary.success_rate_percent}%</div></div>`;
            html += '</div>';
            html += '</div>';
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–∏–ª–æ—Ç–∞–º
            if (data.pilots.length > 0) {
                html += '<div class="report-section">';
                html += '<h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–∏–ª–æ—Ç–∞–º</h3>';
                html += '<div class="table-container">';
                html += '<table id="pilotsTable"><thead><tr>';
                html += '<th style="min-width: 200px;"><input type="text" class="column-search" placeholder="üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫..." data-column="0" style="width: 100%; padding: 8px; background: #2d2d2d; border: 2px solid #03dac6; color: #e0e0e0; border-radius: 4px; font-size: 13px;"></th>';
                html += '<th>–í—Å–µ–≥–æ</th><th>–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ</th><th>–ü–æ—Ä–∞–∂–µ–Ω–æ</th><th>–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ</th><th>% –£—Å–ø–µ—Ö–∞</th>';
                html += '</tr></thead><tbody>';
                data.pilots.forEach(pilot => {
                    html += `<tr>
                        <td>${pilot.pilot_name}</td>
                        <td>${pilot.total_flights}</td>
                        <td>${pilot.destroyed_flights}</td>
                        <td>${pilot.defeated_flights}</td>
                        <td>${pilot.not_defeated_flights}</td>
                        <td>${pilot.success_rate_percent}%</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
                html += `<div style="margin-top: 10px; padding: 8px; background: #2d2d2d; border-radius: 4px; color: #03dac6; font-size: 12px; font-weight: bold;">üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${data.pilots.length}</div>`;
                html += '</div>';
                
                // –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ –ø–∏–ª–æ—Ç–∞–º
                html += '<div class="chart-container"><canvas id="pilotsChart"></canvas></div>';
                html += '</div>';
            }
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–µ–ª—è–º
            if (data.targets.length > 0) {
                html += '<div class="report-section">';
                html += '<h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–µ–ª—è–º</h3>';
                html += '<div class="table-container">';
                html += '<table id="targetsTable"><thead><tr>';
                html += '<th style="min-width: 200px;"><input type="text" class="column-search" placeholder="üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫..." data-column="0" style="width: 100%; padding: 8px; background: #2d2d2d; border: 2px solid #03dac6; color: #e0e0e0; border-radius: 4px; font-size: 13px;"></th>';
                html += '<th>–í—Å–µ–≥–æ</th><th>–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ</th><th>–ü–æ—Ä–∞–∂–µ–Ω–æ</th><th>–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ</th>';
                html += '</tr></thead><tbody>';
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –í–°–ï —Ü–µ–ª–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
                data.targets.forEach(target => {
                    html += `<tr>
                        <td>${target.target}</td>
                        <td>${target.total_flights}</td>
                        <td>${target.destroyed_flights}</td>
                        <td>${target.defeated_flights}</td>
                        <td>${target.not_defeated_flights}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
                html += `<div style="margin-top: 10px; padding: 8px; background: #2d2d2d; border-radius: 4px; color: #03dac6; font-size: 12px; font-weight: bold;">üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${data.targets.length} (–ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏)</div>`;
                html += '</div>';
                
                // –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ —Ü–µ–ª—è–º
                html += '<div class="chart-container"><canvas id="targetsChart"></canvas></div>';
                html += '</div>';
            }
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥—Ä–æ–Ω–∞–º
            if (data.drones.length > 0) {
                html += '<div class="report-section">';
                html += '<h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥—Ä–æ–Ω–∞–º</h3>';
                html += '<div class="table-container">';
                html += '<table id="dronesTable"><thead><tr>';
                html += '<th style="min-width: 200px;"><input type="text" class="column-search" placeholder="üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫..." data-column="0" style="width: 100%; padding: 8px; background: #2d2d2d; border: 2px solid #03dac6; color: #e0e0e0; border-radius: 4px; font-size: 13px;"></th>';
                html += '<th>–í—Å–µ–≥–æ</th><th>–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ</th><th>–ü–æ—Ä–∞–∂–µ–Ω–æ</th><th>–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ</th>';
                html += '</tr></thead><tbody>';
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –í–°–ï –¥—Ä–æ–Ω—ã –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
                data.drones.forEach(drone => {
                    html += `<tr>
                        <td>${drone.drone}</td>
                        <td>${drone.total_flights}</td>
                        <td>${drone.destroyed_flights}</td>
                        <td>${drone.defeated_flights}</td>
                        <td>${drone.not_defeated_flights}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
                html += `<div style="margin-top: 10px; padding: 8px; background: #2d2d2d; border-radius: 4px; color: #03dac6; font-size: 12px; font-weight: bold;">üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${data.drones.length} (–ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏)</div>`;
                html += '</div>';
                html += '</div>';
            }
            
            // –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–∞—Ç–∞–º
            if (data.daily_trend.length > 0) {
                html += '<div class="report-section">';
                html += '<h3>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–∞—Ç–∞–º</h3>';
                html += '<div class="chart-container"><canvas id="dailyChart"></canvas></div>';
                html += '</div>';
            }
            
            reportContent.innerHTML = html;
            
            console.log('–û—Ç—á–µ—Ç –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π:', {
                pilots: data.pilots.length,
                targets: data.targets.length,
                drones: data.drones ? data.drones.length : 0
            });
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –¥–∏–∞–≥—Ä–∞–º–º—ã (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º, –Ω–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü)
            if (data.pilots.length > 0) {
                renderPilotsChart(data.pilots.slice(0, 20)); // –¢–æ–ø-20 –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã
            }
            if (data.targets.length > 0) {
                renderTargetsChart(data.targets.slice(0, 15)); // –¢–æ–ø-15 –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã
            }
            if (data.daily_trend.length > 0) {
                renderDailyChart(data.daily_trend);
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ DOM –æ–±–Ω–æ–≤–ª–µ–Ω
            setTimeout(() => {
                setupTableSearch();
                console.log('–ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ–π –ø–æ–∏—Å–∫–∞:', document.querySelectorAll('.column-search').length);
            }, 200);
        }

        function renderPilotsChart(pilots) {
            const ctx = document.getElementById('pilotsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: pilots.slice(0, 20).map(p => p.pilot_name),
                    datasets: [{
                        label: '–í—Å–µ–≥–æ –≤—ã–ª–µ—Ç–æ–≤',
                        data: pilots.slice(0, 20).map(p => p.total_flights),
                        backgroundColor: '#366092'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e0e0e0' } }
                    },
                    scales: {
                        y: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º —Ç–∞–±–ª–∏—Ü—ã
        function setupTableSearch() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
            const existingHandlers = document.querySelectorAll('.column-search');
            existingHandlers.forEach(input => {
                input.removeEventListener('input', handleSearch);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –ø–æ–∏—Å–∫–∞
            function handleSearch(e) {
                const searchInput = e.target;
                if (!searchInput.classList.contains('column-search')) return;
                
                const table = searchInput.closest('table');
                if (!table) return;
                
                const columnIndex = parseInt(searchInput.dataset.column);
                const searchTerm = searchInput.value.toLowerCase().trim();
                
                const rows = table.querySelectorAll('tbody tr');
                let visibleCount = 0;
                rows.forEach(row => {
                    const cell = row.cells[columnIndex];
                    if (cell) {
                        const cellText = cell.textContent.toLowerCase();
                        if (!searchTerm || cellText.includes(searchTerm)) {
                            row.style.display = '';
                            visibleCount++;
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
                
                console.log(`–ü–æ–∏—Å–∫ –ø–æ —Å—Ç–æ–ª–±—Ü—É ${columnIndex}: "${searchTerm}", –Ω–∞–π–¥–µ–Ω–æ: ${visibleCount} –∏–∑ ${rows.length}`);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ document –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.addEventListener('input', handleSearch);
            
            // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π
            document.querySelectorAll('.column-search').forEach(input => {
                input.addEventListener('input', handleSearch);
            });
        }

        function renderTargetsChart(targets) {
            const ctx = document.getElementById('targetsChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: targets.map(t => t.target),
                    datasets: [{
                        data: targets.map(t => t.total_flights),
                        backgroundColor: [
                            '#366092', '#03dac6', '#bb86fc', '#cf6679', '#6200ee',
                            '#7c3aed', '#18ffff', '#b00020', '#ff6f00', '#ffc107'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e0e0e0' }, position: 'right' }
                    }
                }
            });
        }

        function renderDailyChart(dailyTrend) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyTrend.map(d => d.date),
                    datasets: [
                        {
                            label: '–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ',
                            data: dailyTrend.map(d => d.destroyed_flights),
                            borderColor: '#b00020',
                            backgroundColor: 'rgba(176, 0, 32, 0.1)',
                            fill: true
                        },
                        {
                            label: '–ü–æ—Ä–∞–∂–µ–Ω–æ',
                            data: dailyTrend.map(d => d.defeated_flights),
                            borderColor: '#ff6f00',
                            backgroundColor: 'rgba(255, 111, 0, 0.1)',
                            fill: true
                        },
                        {
                            label: '–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ',
                            data: dailyTrend.map(d => d.not_defeated_flights),
                            borderColor: '#666',
                            backgroundColor: 'rgba(102, 102, 102, 0.1)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e0e0e0' } }
                    },
                    scales: {
                        y: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        function resetFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('pilotsSearch').value = '';
            document.getElementById('targetsSearch').value = '';
            document.getElementById('dronesSearch').value = '';
            document.getElementById('resultsSearch').value = '';
            document.getElementById('pilotsFilter').selectedIndex = -1;
            document.getElementById('targetsFilter').selectedIndex = -1;
            document.getElementById('dronesFilter').selectedIndex = -1;
            document.getElementById('resultsFilter').selectedIndex = -1;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            document.getElementById('targetsFilterGroup').style.display = 'none';
            document.getElementById('dronesFilterGroup').style.display = 'none';
            document.getElementById('resultsFilterGroup').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞
            ['pilotsFilter', 'targetsFilter', 'dronesFilter', 'resultsFilter'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.querySelectorAll('option').forEach(option => {
                        option.style.display = '';
                    });
                }
            });
            
            document.getElementById('reportContent').innerHTML = '<div class="loading" style="padding: 20px; text-align: center;"><h3 style="color: #03dac6;">üìä –û—Ç—á–µ—Ç—ã</h3><p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã" –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞</p></div>';
            document.getElementById('exportExcelBtn').disabled = true;
            currentReportData = null;
        }

        function exportToExcel() {
            if (!currentFilters) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç');
                return;
            }
            
            const params = new URLSearchParams();
            Object.keys(currentFilters).forEach(key => {
                if (Array.isArray(currentFilters[key])) {
                    currentFilters[key].forEach(val => params.append(key, val));
                } else if (currentFilters[key]) {
                    params.append(key, currentFilters[key]);
                }
            });
            
            window.location.href = `/api/reports/export/excel/?${params.toString()}`;
        }


        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≤–µ—Ä—Å–∏—è: 2.0');
            loadFilters();
            // setupTableSearch –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –æ—Ç—á–µ—Ç–∞
        });
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    </script>
</body>
</html>

