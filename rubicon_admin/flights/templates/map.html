<!DOCTYPE html>
{% load static %}
<html>
<head>
    <title>–ö–∞—Ä—Ç–∞ –ø–æ–ª–µ—Ç–æ–≤</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –º–µ–Ω—é - –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ includes/navigation.html */
        .top-nav {
            background: #8B0000;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(255, 0, 0, 0.3);
            border-bottom: 2px solid #ff0000;
            z-index: 1000;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        .nav-links {
            display: flex;
            gap: 30px;
        }

        .nav-links a {
            color: #ffcccc;
            text-decoration: none;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nav-links a.active {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .user-info {
            color: #ffcccc;
            font-size: 14px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            display: flex;
            height: calc(100vh - 60px);
            width: 100%;
        }

        /* –ö–∞—Ä—Ç–∞ */
        .map-container {
            flex: 1;
            height: 100%;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π */
        .sidebar {
            width: 350px;
            background: #1a1a1a;
            border-left: 1px solid #ff0000;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 15px;
            background: #330000;
            border-bottom: 2px solid #ff3333;
            text-align: center;
        }

        .sidebar-header h3 {
            margin: 0;
            color: #ff6666;
            font-size: 18px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .filter-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
            position: relative;
        }
        .filter-section-header {
            display: flex;
            justify-content: space-between; /* –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –∫—Ä–∞—è–º */
            align-items: center; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
            cursor: pointer; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ */
            padding: 5px 0; /* –ù–µ–º–Ω–æ–≥–æ –æ—Ç—Å—Ç—É–ø–∞ */
            user-select: none; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º –∫–ª–∏–∫–µ */
        }
        .filter-section-header::after {
            content: '‚ñº'; /* –°—Ç—Ä–µ–ª–æ—á–∫–∞ –≤–Ω–∏–∑ */
            font-size: 12px;
            color: #ff9999;
            transition: transform 0.3s ease; /* –ü–ª–∞–≤–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ */
        }
        .filter-section.collapsed .filter-section-header::after {
            transform: rotate(-90deg); /* –ü–æ–≤–æ—Ä–æ—Ç —Å—Ç—Ä–µ–ª–æ—á–∫–∏ –≤–ª–µ–≤–æ –ø—Ä–∏ —Å–≤–µ—Ä–Ω—É—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ */
        }
        .filter-section-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out;
            max-height: 10000px;
            opacity: 1;
        }
        .filter-section.collapsed .filter-section-content {
            max-height: 0;
            opacity: 0;
            padding: 0 15px; /* –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ padding */
        }
        /* –£–±–∏—Ä–∞–µ–º –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ —Å–≤–µ—Ä–Ω—É—Ç–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–µ */
        .filter-section.collapsed .filter-section-content > :last-child {
             border-bottom: none;
             margin-bottom: 0;
             padding-bottom: 0;
        }
        /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å –≤ –±–∞–∑–æ–≤–æ–º —Å—Ç–∏–ª–µ */
        .filter-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞, –µ—Å–ª–∏ –æ–Ω —Å–≤–µ—Ä–Ω—É—Ç */
        .filter-section:last-child.collapsed .filter-section-content {
            padding-bottom: 0;
        }



        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
        .filter-section h4 {
            color: #ff6666;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ —á–µ–∫–±–æ–∫—Å–æ–≤ */
        .checkbox-group-separator {
            height: 1px;
            background: #ff3333;
            margin: 10px 0;
            opacity: 0.5;
        }


        .filter-section label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: #ff9999;
            margin-bottom: 5px;
        }

        .filter-section select, .filter-section input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ff3333;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
            background: #2a2a2a;
            color: #fff;
            margin-bottom: 10px;
        }

        .date-filters {
            display: flex;
            gap: 10px;
        }

        .date-filters input {
            width: calc(50% - 5px);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .filter-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .apply-btn {
            background: #cc0000;
            color: white;
            border: 1px solid #ff3333;
        }

        .apply-btn:hover {
            background: #ff0000;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .reset-btn {
            background: #333333;
            color: #ff6666;
            border: 1px solid #666666;
        }

        .reset-btn:hover {
            background: #444444;
            color: #ff9999;
            box-shadow: 0 0 10px rgba(255, 102, 102, 0.3);
        }
        .export-btn {
            background: #4caf50;
            color: white;
            border: 1px solid #45a049;
        }
        .export-btn:hover {
            background: #45a049;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        .export-btn:disabled {
            background: #666;
            color: #aaa;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .stats-panel {
            background: #2a2a2a;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #ff3333;
            max-height: 300px;
            overflow-y: auto;
        }

        .stats-header {
            font-weight: bold;
            color: #ff6666;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ff3333;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stats-item {
            font-size: 12px;
            margin-bottom: 5px;
            padding: 3px 0;
            color: #ccc;
        }

        .stats-item.type {
            display: flex;
            justify-content: space-between;
        }

        .stats-item.type span:last-child {
            font-weight: bold;
            color: #ff9999;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            z-index: 2000;
            border: 1px solid #ff0000;
            color: #ff6666;
            text-align: center;
        }

        .result-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .effective { background-color: #00cc00; }
        .ineffective { background-color: #ff3333; }
        .no-data {
            color: #666;
            font-style: italic;
            text-align: center;
        }

        /* Scrollbar –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        ::-webkit-scrollbar-thumb {
            background: #ff3333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ff0000;
        }

        .stats-count {
            color: #ff9999;
            font-weight: bold;
        }

        .filters-header h3 {
            margin: 0;
            background: linear-gradient(45deg, #ff0000, #8B0000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }

        .today-button-container {
            margin-top: 10px;
        }

        .today-btn {
            width: 100%;
            padding: 8px 12px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π padding */
            background: linear-gradient(45deg, #4a4a4a, #2a2a2a); /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            color: #cccccc; /* –°–µ—Ä—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
            border: 1px solid #555555; /* –¢–µ–º–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
            border-radius: 4px; /* –ú–µ–Ω—å—à–∏–π —Ä–∞–¥–∏—É—Å —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è */
            cursor: pointer;
            font-weight: normal; /* –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –≤–µ—Å —à—Ä–∏—Ñ—Ç–∞ –≤–º–µ—Å—Ç–æ bold */
            font-size: 12px; /* –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            text-transform: none; /* –£–±—Ä–∞–Ω uppercase */
            letter-spacing: 0.5px;
            transition: all 0.2s ease; /* –ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); /* –ú–µ–Ω–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–Ω–∞—è —Ç–µ–Ω—å */
        }

        .today-btn:hover {
            background: linear-gradient(45deg, #5a5a5a, #3a3a3a); /* –ù–µ–º–Ω–æ–≥–æ —Å–≤–µ—Ç–ª–µ–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
            box-shadow: 0 0 5px rgba(100, 100, 100, 0.3); /* –ú–µ–Ω–µ–µ —è—Ä–∫–∞—è —Ç–µ–Ω—å */
            color: #eeeeee; /* –ë–µ–ª–µ–µ —Ç–µ–∫—Å—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
            transform: none; /* –£–±—Ä–∞–Ω–æ –¥–≤–∏–∂–µ–Ω–∏–µ */
        }

        .today-btn:active {
            transform: translateY(0); /* –£–±—Ä–∞–Ω–æ –¥–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
        }

        .today-btn:focus {
            outline: none;
            box-shadow: 0 0 0 1px rgba(100, 100, 100, 0.3);
        }

        #updateIndicator {
            display: none;
            margin-top: 10px;
            text-align: center;
            color: #ff9999;
            font-size: 12px;
        }

        .update-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ff3333;
            border-top: 2px solid #ff9999;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */

        .refresh-btn {
            background: #333;
            color: #ff6666;
        }

        .refresh-btn:hover {
            background: #444;
            color: #ff9999;
            box-shadow: 0 0 10px rgba(255, 102, 102, 0.3);
        }


        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            font-size: 14px;
            font-weight: bold;
            animation: slideIn 0.3s ease;
        }

        .notification.info {
            background: #3399ff;
            color: white;
            border: 1px solid #0066cc;
        }

        .notification.success {
            background: #00cc66;
            color: white;
            border: 1px solid #00994d;
        }

        .notification.error {
            background: #ff3333;
            color: white;
            border: 1px solid #cc0000;
        }

        .notification.warning {
            background: #ff9900;
            color: white;
            border: 1px solid #cc7a00;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ —á–µ–∫–±–æ–∫—Å–æ–≤ */
        .checkbox-group-separator {
            height: 1px;
            background: #ff3333;
            margin: 10px 0;
            opacity: 0.5;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            /* 1. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
            .top-nav {
                padding: 0 10px;
                height: 50px;
                position: relative;
                z-index: 1001;
            }
            .nav-links {
                position: fixed;
                left: -100%;
                top: 50px;
                flex-direction: column;
                background-color: #8B0000;
                width: 100%;
                text-align: center;
                transition: 0.3s;
                box-shadow: 0 10px 27px rgba(0, 0, 0, 0.05);
                z-index: 1000;
                gap: 0;
            }
            .nav-links.active {
                left: 0;
            }
            .nav-links a {
                display: block;
                padding: 15px;
                border-bottom: 1px solid rgba(255, 204, 204, 0.1);
            }
            .nav-toggle {
                display: block;
                cursor: pointer;
            }
            .nav-toggle .bar {
                display: block;
                width: 25px;
                height: 3px;
                margin: 5px auto;
                background-color: #ffcccc;
                transition: 0.3s;
            }
            .nav-toggle.active .bar:nth-child(2) {
                opacity: 0;
            }
            .nav-toggle.active .bar:nth-child(1) {
                transform: translateY(8px) rotate(45deg);
            }
            .nav-toggle.active .bar:nth-child(3) {
                transform: translateY(-8px) rotate(-45deg);
            }

            /* 2. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
            .main-content {
                flex-direction: column;
                height: calc(100vh - 50px);
            }
            .sidebar {
                width: 100%;
                height: 0;
                position: absolute;
                top: 50px;
                left: 0;
                z-index: 998;
                overflow: hidden;
                transition: height 0.3s ease;
                border-left: none;
                border-top: 1px solid #ff0000;
            }
            .sidebar.active {
                height: calc(100vh - 50px);
            }
            .sidebar-header {
                padding: 10px;
            }
            .sidebar-header h3 {
                font-size: 16px;
            }
            .filter-toggle-mobile {
                display: block;
                position: absolute;
                left: 10px;
                right: 10px;
                background: #cc0000;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
                z-index: 999;
                font-size: 14px;
                width: fit-content;
            }

            /* 3. –°–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
            #autoUpdatePanelContainer {
                display: none !important;
            }

            /* –°–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
            .filter-toggle-mobile {
                display: block;
            }
        }

        @media (min-width: 769px) {
            .nav-toggle {
                display: none;
            }
            .filter-toggle-mobile {
                display: none;
            }
        }

    </style>
</head>
<body>
    <!-- –ò–ú–ü–û–†–¢–ò–†–£–ï–ú –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ -->
    {% include 'includes/navigation.html' %}
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–±—É—Ä–≥–µ—Ä" -->
    <div class="nav-toggle" id="mobile-menu">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
    </div>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content">
        <div class="map-container">
            <div id="map">
                <button class="filter-toggle-mobile" id="mobileFilterToggle">–§–∏–ª—å—Ç—Ä</button>
            </div>
            <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã –∏ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <h3>–§–∏–ª—å—Ç—Ä—ã –ø–æ–ª–µ—Ç–æ–≤</h3>
                <div class="coordinate-info">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –°–ö-42 ‚Üí WGS-84</div>
            </div>

            <div class="sidebar-content">
                <div class="filter-section">
                    <label>–ü–∏–ª–æ—Ç:</label>
                    <select id="pilotFilter">
                        <option value="">–í—Å–µ –ø–∏–ª–æ—Ç—ã</option>
                    </select>
                </div>

                <div class="filter-section" data-filter-id="target">
                    <div class="filter-section-header">
                        <label>–¢–∏–ø —Ü–µ–ª–∏:</label>
                    </div>
                    <div class="filter-section-content">
                        <div id="targetCheckboxesContainer">
                            <div class="checkbox-item">
                                <input type="checkbox" id="targetCheckboxAll" onchange="toggleAllTargets(this)">
                                <label for="targetCheckboxAll">–í—Å–µ —Ç–∏–ø—ã</label>
                            </div>
                            <div class="checkbox-group-separator"></div>
                            <div id="targetCheckboxes" class="checkbox-group">
                                <!-- –ß–µ–∫–±–æ–∫—Å—ã –¥–ª—è —Ç–∏–ø–æ–≤ —Ü–µ–ª–µ–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!--<div class="filter-section">
                    <label>–†–µ–∑—É–ª—å—Ç–∞—Ç:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="missCheckbox" value="–ø—Ä–æ–º–∞—Ö" checked>
                            <label for="missCheckbox">–ü—Ä–æ–º–∞—Ö</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hitCheckbox" value="–ø–æ–ø–∞–¥–∞–Ω–∏–µ" checked>
                            <label for="hitCheckbox">–ü–æ–ø–∞–¥–∞–Ω–∏–µ</label>
                        </div>
                    </div>
                </div>-->

                <div class="filter-section">
                    <label>–ü–æ–∏—Å–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º:</label>
                    <input type="text" id="coordinatesSearch" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5350000 7360000 –∏–ª–∏ 5350000,7360000" style="width: 100%; padding: 5px; margin-top: 5px;">
                    <small style="color: #666; display: block; margin-top: 3px;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã X Y (—á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª –∏–ª–∏ –∑–∞–ø—è—Ç—É—é)</small>
                </div>

                <div class="filter-section">
                    <label>–î–∞—Ç–∞:</label>
                    <div class="date-filters">
                        <input type="date" id="dateFrom" placeholder="–° –¥–∞—Ç—ã">
                        <input type="date" id="dateTo" placeholder="–ü–æ –¥–∞—Ç—É">
                    </div>
                    <div class="today-button-container">
                        <button class="today-btn" onclick="showTodayFlights()" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è">
                            üìÖ –°–µ–≥–æ–¥–Ω—è
                        </button>
                    </div>
                </div>

                <div class="filter-buttons">
                    <button class="apply-btn" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button class="reset-btn" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
                
                <div class="filter-section" style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 10px; color: #ff6666; font-weight: bold;">–≠–∫—Å–ø–æ—Ä—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:</label>
                    <button class="btn export-btn" onclick="exportToCSV()" style="width: 100%; padding: 10px; margin-bottom: 8px; background: #2d5016; border-color: #4a7c2a;">
                        üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                    </button>
                    <button class="btn export-btn" onclick="exportToKML()" style="width: 100%; padding: 10px; margin-bottom: 8px; background: #1a3d5c; border-color: #2d5f8f;">
                        üåç –≠–∫—Å–ø–æ—Ä—Ç –≤ KML (Google Earth)
                    </button>
                    <button class="btn export-btn" id="exportGpxBtn" onclick="exportToAlpineQuest()" style="width: 100%; padding: 10px; background: #5a1a3d; border-color: #8a2d5f;">
                        üìç –≠–∫—Å–ø–æ—Ä—Ç –≤ GPX (AlpineQuest)
                    </button>
                    <small style="color: #666; display: block; margin-top: 8px; text-align: center; font-size: 11px;">
                        –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                    </small>
                </div>

                <div class="stats-panel">
                    <div class="stats-header">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–µ—Ç–æ–≤</div>
                    <div id="statisticsContent">
                        <div class="stats-item no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.YANDEX_API_KEY = "{{ yandex_api_key }}";
        console.log(window.YANDEX_API_KEY);
        let myMap;
        let objectManager;
        let allFlights = [];
        let filteredFlights = [];
        let pilotsList = new Set();
        let targetsList = new Set();
        let currentMapBounds = null;
        let isUpdating = false;


        function loadYandexMap() {
            if (!window.YANDEX_API_KEY || window.YANDEX_API_KEY === 'None' || window.YANDEX_API_KEY === '') {
                document.getElementById('loading').innerHTML = 'API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.';
                return;
            }

            const script = document.createElement('script');
            script.src = `https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=${window.YANDEX_API_KEY}`;
            script.onload = () => {
                if (typeof ymaps !== 'undefined') {
                    ymaps.ready(init);
                } else {
                    mapLoadError();
                }
            };
            script.onerror = mapLoadError;
            document.head.appendChild(script);
        }

        function init() {
            document.getElementById('loading').style.display = 'none';

            myMap = new ymaps.Map("map", {
                center: [55.7558, 37.6176],
                zoom: 3,
                type: 'yandex#hybrid',
                controls: ['zoomControl', 'typeSelector', 'fullscreenControl']
            });

            objectManager = new ymaps.ObjectManager({
                clusterize: true,
                gridSize: 64,
                clusterDisableClickZoom: false
            });

            objectManager.clusters.options.set({
                preset: 'islands#invertedRedClusterIcons'
            });

            myMap.geoObjects.add(objectManager);

            loadFlights();
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function saveCurrentMapBounds() {
            try {
                if (myMap && typeof myMap.getBounds === 'function') {
                    currentMapBounds = myMap.getBounds();
                    console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã:', currentMapBounds);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç—ã:', error);
            }
        }

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫
        function restoreMapBounds() {
            try {
                if (currentMapBounds && myMap) {
                    console.log('–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã:', currentMapBounds);
                    myMap.setBounds(currentMapBounds, {
                        checkZoomRange: true,
                        zoomMargin: [20, 20, 20, 20],
                        duration: 300 // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç—ã:', error);
            }
        }

        function toggleFilterSection(sectionElement) {
            sectionElement.classList.toggle('collapsed');
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            const filterId = sectionElement.getAttribute('data-filter-id');
            if (filterId) {
                const isCollapsed = sectionElement.classList.contains('collapsed');
                try {
                    localStorage.setItem(`filterCollapsed_${filterId}`, isCollapsed);
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –≤ localStorage:', e);
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function initFilterCollapseState() {
            const filterSections = document.querySelectorAll('.filter-section[data-filter-id]');
            filterSections.forEach(section => {
                const filterId = section.getAttribute('data-filter-id');
                if (filterId) {
                    try {
                        const savedState = localStorage.getItem(`filterCollapsed_${filterId}`);
                        if (savedState !== null) {
                            const isCollapsed = JSON.parse(savedState);
                            if (isCollapsed) {
                                section.classList.add('collapsed');
                            } else {
                                section.classList.remove('collapsed'); // –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∫–ª–∞—Å—Å –±—ã–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                            }
                        }
                        // –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç, —Ñ–∏–ª—å—Ç—Ä –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç)
                    } catch (e) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –∏–∑ localStorage:', e);
                        // –û—Å—Ç–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                    }
                }
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞
                const header = section.querySelector('.filter-section-header');
                if (header) {
                    header.addEventListener('click', () => toggleFilterSection(section));
                }
            });
        }


        function showTodayFlights() {
            console.log('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª–µ—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è...');

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD –ë–ï–ó —Å–º–µ—â–µ–Ω–∏—è
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;

            console.log('–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞:', todayString);

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã "—Å" –∏ "–ø–æ" –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
            document.getElementById('dateFrom').value = todayString;
            document.getElementById('dateTo').value = todayString;

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∫–∞–∫ –æ–±—ã—á–Ω–æ
            applyFilters();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(`–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ–ª–µ—Ç—ã –∑–∞ ${today.toLocaleDateString('ru-RU')}`, 'info');
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        function showNotification(message, type = 'info') {
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'info' ? '#3399ff' : type === 'success' ? '#00cc66' : '#ff3333'};
                color: white;
                padding: 15px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 3000;
                font-size: 14px;
                font-weight: bold;
                animation: slideIn 0.3s ease;
            `;

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(notification);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.5s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 3000);
        }

                function applyFilters() {
            console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã...');
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã –ø–µ—Ä–µ–¥ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
            saveCurrentMapBounds();
            const pilotFilter = document.getElementById('pilotFilter').value;
            // const targetFilter = document.getElementById('targetFilter').value; // –£–¥–∞–ª–µ–Ω–æ

            // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ü–µ–ª–µ–π
            const selectedTargets = Array.from(document.querySelectorAll('.target-checkbox:checked')).map(cb => cb.value);
            const isTargetFilterActive = selectedTargets.length > 0 && selectedTargets.length < targetsList.size; // –ê–∫—Ç–∏–≤–µ–Ω, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã –Ω–µ –≤—Å–µ
            // --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –õ–û–ì–ò–ö–ò ---

            // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            const coordinatesSearch = document.getElementById('coordinatesSearch').value.trim();
            let searchCoords = null;
            if (coordinatesSearch) {
                // –ü–∞—Ä—Å–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç—ã "X Y", "X,Y", "X, Y"
                const coordsMatch = coordinatesSearch.match(/(\d+(?:\.\d+)?)[\s,]+(\d+(?:\.\d+)?)/);
                if (coordsMatch) {
                    searchCoords = {
                        x: parseFloat(coordsMatch[1]),
                        y: parseFloat(coordsMatch[2])
                    };
                }
            }
            
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            console.log('–§–∏–ª—å—Ç—Ä—ã:', {
                pilotFilter,
                selectedTargets, // –û–±–Ω–æ–≤–ª–µ–Ω–æ
                isTargetFilterActive, // –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                coordinatesSearch,
                searchCoords,
                dateFrom,
                dateTo
            });

            // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            filteredFlights = allFlights.filter(flight => {
                // –§–∏–ª—å—Ç—Ä –ø–æ –ø–∏–ª–æ—Ç—É
                if (pilotFilter && flight.pilot_name !== pilotFilter) {
                    return false;
                }
                // --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –§–ò–õ–¨–¢–† –ü–û –¢–ò–ü–£ –¶–ï–õ–ò ---
                // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É —Ü–µ–ª–∏: –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥–∏—Ç –ª–∏ —Ü–µ–ª—å –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                if (isTargetFilterActive && !selectedTargets.includes(flight.target)) {
                    return false;
                }
                // --- –ö–û–ù–ï–¶ –û–ë–ù–û–í–õ–ï–ù–ù–û–ì–û –§–ò–õ–¨–¢–†–ê ---
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–ª–∏—á–∏—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                if (!flight.coordinates_info) {
                    return false;
                }
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                if (searchCoords) {
                    const flightCoords = flight.coordinates;
                    if (flightCoords) {
                        // –ü–∞—Ä—Å–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª–µ—Ç–∞ (—Ñ–æ—Ä–º–∞—Ç "X Y")
                        const flightCoordsMatch = flightCoords.match(/(\d+(?:\.\d+)?)[\s,]+(\d+(?:\.\d+)?)/);
                        if (flightCoordsMatch) {
                            const flightX = parseFloat(flightCoordsMatch[1]);
                            const flightY = parseFloat(flightCoordsMatch[2]);
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ 100 –º–µ—Ç—Ä–æ–≤ (0.0001 –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –º–µ—Ç—Ä–∞—Ö)
                            const tolerance = 100; // –º–µ—Ç—Ä—ã
                            const xDiff = Math.abs(flightX - searchCoords.x);
                            const yDiff = Math.abs(flightY - searchCoords.y);
                            
                            if (xDiff > tolerance || yDiff > tolerance) {
                                return false;
                            }
                        } else {
                            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª–µ—Ç–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                            return false;
                        }
                    } else {
                        // –ï—Å–ª–∏ —É –ø–æ–ª–µ—Ç–∞ –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                        return false;
                    }
                }
                // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –§–ò–õ–¨–¢–† –ü–û –î–ê–¢–ï - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –¥–∞—Ç
                if (dateFrom || dateTo) {
                    if (flight.flight_date) {
                        const flightDateStr = flight.flight_date; // –§–æ—Ä–º–∞—Ç 'YYYY-MM-DD'
                        if (dateFrom && flightDateStr < dateFrom) {
                            return false;
                        }
                        if (dateTo && flightDateStr > dateTo) {
                            return false;
                        }
                    }
                }
                return true;
            });
            console.log(`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: ${filteredFlights.length} –∏–∑ ${allFlights.length}`);
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
            updateFlightsOnMap();
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateVisibleStatistics();
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫
            setTimeout(restoreMapBounds, 500);
        }

        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º
        function applyFiltersAdvanced() {
            console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º)...');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –∏ —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã
            let savedCenter = null;
            let savedZoom = null;
            if (myMap) {
                savedCenter = myMap.getCenter();
                savedZoom = myMap.getZoom();
            }

            const pilotFilter = document.getElementById('pilotFilter').value;
            const targetFilter = document.getElementById('targetFilter').value;

            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            const coordinatesSearch = document.getElementById('coordinatesSearch').value.trim();
            let searchCoords = null;
            if (coordinatesSearch) {
                const coordsMatch = coordinatesSearch.match(/(\d+(?:\.\d+)?)[\s,]+(\d+(?:\.\d+)?)/);
                if (coordsMatch) {
                    searchCoords = {
                        x: parseFloat(coordsMatch[1]),
                        y: parseFloat(coordsMatch[2])
                    };
                }
            }

            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            filteredFlights = allFlights.filter(flight => {
                if (pilotFilter && flight.pilot_name !== pilotFilter) return false;
                if (targetFilter && flight.target !== targetFilter) return false;

                if (!flight.coordinates_info) return false;
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                if (searchCoords) {
                    const flightCoords = flight.coordinates;
                    if (flightCoords) {
                        const flightCoordsMatch = flightCoords.match(/(\d+(?:\.\d+)?)[\s,]+(\d+(?:\.\d+)?)/);
                        if (flightCoordsMatch) {
                            const flightX = parseFloat(flightCoordsMatch[1]);
                            const flightY = parseFloat(flightCoordsMatch[2]);
                            const tolerance = 100; // –º–µ—Ç—Ä—ã
                            const xDiff = Math.abs(flightX - searchCoords.x);
                            const yDiff = Math.abs(flightY - searchCoords.y);
                            if (xDiff > tolerance || yDiff > tolerance) {
                                return false;
                            }
                        } else {
                            return false;
                        }
                    } else {
                        return false;
                    }
                }

                if (dateFrom || dateTo) {
                    if (flight.flight_date) {
                        const flightDate = new Date(flight.flight_date);
                        if (dateFrom && flightDate < new Date(dateFrom)) return false;
                        if (dateTo && flightDate > new Date(dateTo)) return false;
                    }
                }

                return true;
            });

            console.log(`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: ${filteredFlights.length} –∏–∑ ${allFlights.length}`);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
            updateFlightsOnMap();

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–∞—Ä—Ç—ã
            setTimeout(() => {
                try {
                    if (savedCenter && savedZoom && myMap) {
                        myMap.setCenter(savedCenter, savedZoom, {
                            duration: 300,
                            timingFunction: 'ease-in-out'
                        });
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
                    updateVisibleStatistics();
                }
            }, 300);

            updateVisibleStatistics();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è updateFlightsOnMap –±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü
        function updateFlightsOnMap() {
            console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ...');
            objectManager.removeAll();

            const geoObjects = [];

            let skipped_no_coords = 0;
            let skipped_invalid_coords = 0;
            let added_count = 0;
            
            filteredFlights.forEach((flight, index) => {
                if (!flight.coordinates_info) {
                    skipped_no_coords++;
                    if (skipped_no_coords <= 5) {
                        console.log(`–ü—Ä–æ–ø—É—â–µ–Ω –ø–æ–ª–µ—Ç ${index}: –Ω–µ—Ç coordinates_info`, flight.id);
                    }
                    return;
                }

                const coord = flight.coordinates_info;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–æ–ª–µ–µ –≥–∏–±–∫–æ
                const lat = coord.lat_wgs84;
                const lon = coord.lon_wgs84;
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–∞, –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∏
                const latNum = typeof lat === 'number' ? lat : parseFloat(lat);
                const lonNum = typeof lon === 'number' ? lon : parseFloat(lon);
                
                if (isNaN(latNum) || isNaN(lonNum) || latNum === null || lonNum === null) {
                    skipped_invalid_coords++;
                    if (skipped_invalid_coords <= 5) {
                        console.log(`–ü—Ä–æ–ø—É—â–µ–Ω –ø–æ–ª–µ—Ç ${index}: –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã`, flight.id, {lat, lon, latNum, lonNum});
                    }
                    return;
                }
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (90.0, 0.0)
                if (latNum === 90.0 && lonNum === 0.0) {
                    skipped_invalid_coords++;
                    return;
                }

                let preset = 'islands#redIcon'; // destroyed –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (flight.result === 'defeated') {
                    preset = 'islands#orangeIcon';
                } else if (flight.result === 'not defeated') {
                    preset = 'islands#greyIcon';
                }

                const feature = {
                    type: 'Feature',
                    id: flight.id,
                    geometry: {
                        type: 'Point',
                        coordinates: [latNum, lonNum]
                    },
                    properties: {
                        balloonContentHeader: `<strong>–ü–æ–ª–µ—Ç ‚Ññ${flight.number}</strong>`,
                        balloonContentBody: `
                            <div style="max-width: 350px; color: #000;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <tr><td><strong>–ü–∏–ª–æ—Ç:</strong></td><td>${flight.pilot_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td></tr>
                                    <tr><td><strong>–î—Ä–æ–Ω:</strong></td><td>${flight.drone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td></tr>
                                    <tr><td><strong>–î–∞—Ç–∞:</strong></td><td>${formatDate(flight.flight_date)}</td></tr>
                                    <tr><td><strong>–í—Ä–µ–º—è:</strong></td><td>${flight.flight_time || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td></tr>
                                    <tr><td><strong>–¢–∏–ø —Ü–µ–ª–∏:</strong></td><td>${flight.target || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td></tr>
                                    <tr><td><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong></td><td>${getResultDisplay(flight.result)}</td></tr>
                                    <tr><td><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong></td><td>${flight.coordinates || '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}</td></tr>
                                </table>
                                <div style="margin-top: 10px; padding-top: 5px; border-top: 1px solid #eee;">
                                    <small><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong><br>
                                    ${flight.comment}</small>
                                </div>
                            </div>
                        `,
                        hintContent: `–ü–æ–ª–µ—Ç ‚Ññ${flight.number} - ${flight.pilot_name || '–ë–µ–∑ –ø–∏–ª–æ—Ç–∞'}`
                    },
                    options: {
                        preset: preset
                    }
                };

                geoObjects.push(feature);
                added_count++;
            });
            
            console.log(`–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–æ—á–µ–∫ –Ω–∞ –∫–∞—Ä—Ç—É: ${added_count}, –ø—Ä–æ–ø—É—â–µ–Ω–æ –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: ${skipped_no_coords}, –ø—Ä–æ–ø—É—â–µ–Ω–æ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö: ${skipped_invalid_coords}`);
            console.log('–°–æ–∑–¥–∞–Ω–æ –≥–µ–æ–æ–±—ä–µ–∫—Ç–æ–≤:', geoObjects.length);
            console.log(`–í—Å–µ–≥–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ–ª–µ—Ç–æ–≤: ${filteredFlights.length}`);
            if (added_count === 0 && filteredFlights.length > 0) {
                console.warn('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ—Ç —Ç–æ—á–µ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ, –Ω–æ –µ—Å—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª–µ—Ç—ã!');
                if (filteredFlights.length > 0) {
                    console.log('–ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª–µ—Ç–∞:', filteredFlights[0]);
                    console.log('coordinates_info –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª–µ—Ç–∞:', filteredFlights[0]?.coordinates_info);
                }
            }

            if (geoObjects.length > 0) {
                objectManager.add({
                    type: 'FeatureCollection',
                    features: geoObjects
                });

                console.log('–¢–æ—á–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç—É');

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç—ã
                setTimeout(updateVisibleStatistics, 200);

            } else {
                console.log('–ù–µ—Ç —Ç–æ—á–µ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                updateVisibleStatistics();
            }

            setupVisibilityListener();
        }

        function collectFilterValues() {
            pilotsList.clear();
            targetsList.clear();

            allFlights.forEach(flight => {
                if (flight.pilot_name) pilotsList.add(flight.pilot_name);
                if (flight.target) targetsList.add(flight.target);
            });
        }

        function populateFilterDropdowns() {
            const pilotSelect = document.getElementById('pilotFilter');
            const targetCheckboxesContainer = document.getElementById('targetCheckboxes'); // –ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

            // –û—á–∏—â–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–∏–ª–æ—Ç–æ–≤
            pilotSelect.innerHTML = '<option value="">–í—Å–µ –ø–∏–ª–æ—Ç—ã</option>';
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–µ–∫–±–æ–∫—Å–æ–≤ —Ü–µ–ª–µ–π
            targetCheckboxesContainer.innerHTML = '';

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–∏–ª–æ—Ç–æ–≤
            Array.from(pilotsList).sort().forEach(pilot => {
                const option = document.createElement('option');
                option.value = pilot;
                option.textContent = pilot;
                pilotSelect.appendChild(option);
            });

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —á–µ–∫–±–æ–∫—Å—ã —Ü–µ–ª–µ–π
            const sortedTargets = Array.from(targetsList).sort();
            sortedTargets.forEach(target => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `targetCheckbox_${target}`; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                checkbox.value = target;
                checkbox.checked = true; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ –æ—Ç–º–µ—á–µ–Ω—ã
                checkbox.className = 'target-checkbox'; // –ö–ª–∞—Å—Å –¥–ª—è –ø–æ–∏—Å–∫–∞

                const label = document.createElement('label');
                label.htmlFor = `targetCheckbox_${target}`;
                label.textContent = target;

                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(label);
                targetCheckboxesContainer.appendChild(checkboxItem);
            });

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–í—Å–µ —Ç–∏–ø—ã" –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
            updateSelectAllCheckbox();

            if (!window.isFilterCollapseInitialized) {
                 initFilterCollapseState();
                 window.isFilterCollapseInitialized = true;
            }
        }

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–º "–í—Å–µ —Ç–∏–ø—ã"
        function toggleAllTargets(masterCheckbox) {
            const targetCheckboxes = document.querySelectorAll('.target-checkbox');
            targetCheckboxes.forEach(cb => {
                cb.checked = masterCheckbox.checked;
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ "–í—Å–µ —Ç–∏–ø—ã"
        function updateSelectAllCheckbox() {
            const masterCheckbox = document.getElementById('targetCheckboxAll');
            const targetCheckboxes = document.querySelectorAll('.target-checkbox');
            if (targetCheckboxes.length === 0) {
                masterCheckbox.checked = false;
                masterCheckbox.indeterminate = false;
                return;
            }

            const checkedCount = Array.from(targetCheckboxes).filter(cb => cb.checked).length;

            if (checkedCount === 0) {
                masterCheckbox.checked = false;
                masterCheckbox.indeterminate = false;
            } else if (checkedCount === targetCheckboxes.length) {
                masterCheckbox.checked = true;
                masterCheckbox.indeterminate = false;
            } else {
                masterCheckbox.checked = false;
                masterCheckbox.indeterminate = true; // –ß–∞—Å—Ç–∏—á–Ω–æ –≤—ã–±—Ä–∞–Ω
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º updateSelectAllCheckbox –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞ —Ü–µ–ª–∏
        document.addEventListener('change', function(e) {
             if (e.target && e.target.classList.contains('target-checkbox')) {
                 updateSelectAllCheckbox();
                 // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞
                 applyFilters();
             }
        });

                function resetFilters() {
            document.getElementById('pilotFilter').value = '';
            // –°–±—Ä–æ—Å —á–µ–∫–±–æ–∫—Å–æ–≤ —Ç–∏–ø–æ–≤ —Ü–µ–ª–µ–π
            document.querySelectorAll('.target-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('targetCheckboxAll').checked = true; // –¢–∞–∫–∂–µ —Å–±—Ä–æ—Å–∏—Ç—å "–í—Å–µ —Ç–∏–ø—ã"
            document.getElementById('targetCheckboxAll').indeterminate = false;

            document.getElementById('coordinatesSearch').value = ''; // –°–±—Ä–æ—Å –ø–æ–∏—Å–∫–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            filteredFlights = [...allFlights];
            updateFlightsOnMap();
            updateVisibleStatistics();
        }

        function formatDate(dateString) {
            if (!dateString) return '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }

        function getResultDisplay(result) {
            switch(result) {
                case 'destroyed':
                    return '<span style="color: #ff0000;">‚úó –£–Ω–∏—á—Ç–æ–∂–µ–Ω</span>';
                case 'defeated':
                    return '<span style="color: #ff9900;">‚ö† –ü–æ—Ä–∞–∂–µ–Ω</span>';
                case 'not defeated':
                    return '<span style="color: #888888;">‚óã –ù–µ –ø–æ—Ä–∞–∂–µ–Ω</span>';
                default:
                    return result || '–ù–µ —É–∫–∞–∑–∞–Ω';
            }
        }

        function getVisibleFlights() {
            try {
                const mapBounds = myMap.getBounds();
                if (!mapBounds) return [];

                const [[south, west], [north, east]] = mapBounds;

                const visibleFlightsArray = [];

                filteredFlights.forEach(flight => {
                    if (!flight.coordinates_info) return;

                    const coord = flight.coordinates_info;
                    const lat = coord.lat_wgs84;
                    const lon = coord.lon_wgs84;

                    if (lat >= south && lat <= north && lon >= west && lon <= east) {
                        visibleFlightsArray.push(flight);
                    }
                });

                return visibleFlightsArray;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –≤–∏–¥–∏–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤:', error);
                return [];
            }
        }

        function updateVisibleStatistics() {
            const currentlyVisibleFlights = getVisibleFlights();
            visibleFlights = currentlyVisibleFlights;

            const statsContent = document.getElementById('statisticsContent');

            if (currentlyVisibleFlights.length === 0) {
                statsContent.innerHTML = `
                    <div class="stats-item no-data">–ù–µ—Ç –≤–∏–¥–∏–º—ã—Ö –ø–æ–ª–µ—Ç–æ–≤</div>
                    <div class="stats-item">–í—Å–µ–≥–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: ${filteredFlights.length}</div>
                `;
                return;
            }

            let minDate = null;
            let maxDate = null;
            const targetCounts = {};
            const resultCounts = {};
            let successfulFlights = 0;

            currentlyVisibleFlights.forEach(flight => {
                if (flight.flight_date) {
                    const flightDate = new Date(flight.flight_date);
                    if (!minDate || flightDate < minDate) minDate = flightDate;
                    if (!maxDate || flightDate > maxDate) maxDate = flightDate;
                }

                const target = flight.target || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                targetCounts[target] = (targetCounts[target] || 0) + 1;

                const result = flight.result || '–ù–µ —É–∫–∞–∑–∞–Ω';
                resultCounts[result] = (resultCounts[result] || 0) + 1;

                if (flight.result === 'destroyed') {
                    successfulFlights++;
                }
            });

            let html = '';
            html += `<div class="stats-item"><strong>–í–∏–¥–∏–º–æ: ${currentlyVisibleFlights.length} –∏–∑ ${filteredFlights.length}</strong></div>`;

            if (minDate && maxDate) {
                html += `<div class="stats-item">–ü–µ—Ä–∏–æ–¥: ${minDate.toLocaleDateString('ru-RU')} - ${maxDate.toLocaleDateString('ru-RU')}</div>`;
            } else {
                html += `<div class="stats-item">–ü–µ—Ä–∏–æ–¥ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</div>`;
            }

            html += '<div style="margin: 10px 0; border-top: 1px solid #ff3333; padding-top: 10px;"></div>';

            html += '<div style="margin-bottom: 10px;"><strong>–ü–æ —Ç–∏–ø–∞–º —Ü–µ–ª–µ–π:</strong></div>';
            const sortedTargets = Object.keys(targetCounts)
                .map(target => ({ target, count: targetCounts[target] }))
                .sort((a, b) => b.count - a.count)
                .map(item => item.target);

            sortedTargets.forEach(target => {
                html += `<div class="stats-item type"><span>${target}:</span> <span class="stats-count">${targetCounts[target]}</span></div>`;
            });

            html += '<div style="margin: 10px 0; border-top: 1px solid #666; padding-top: 10px;"></div>';

            html += '<div style="margin-bottom: 10px;"><strong>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong></div>';
            html += `<div class="stats-item type"><span>–í—Å–µ–≥–æ –≤—ã–ª–µ—Ç–æ–≤:</span> <span class="stats-count">${currentlyVisibleFlights.length}</span></div>`;
            html += `<div class="stats-item type"><span>–£—Å–ø–µ—à–Ω–æ:</span> <span class="stats-count">${successfulFlights}</span></div>`;

            if (currentlyVisibleFlights.length > 0) {
                const successRate = Math.round((successfulFlights / currentlyVisibleFlights.length) * 100);
                html += `<div class="stats-item type"><span>–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞:</span> <span class="stats-count">${successRate}%</span></div>`;
            }

            html += '<div style="margin: 10px 0; border-top: 1px solid #666; padding-top: 10px;"></div>';
            html += '<div style="margin-bottom: 10px;"><strong>–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º:</strong></div>';
            const sortedResults = Object.keys(resultCounts)
                .map(result => ({ result, count: resultCounts[result] }))
                .sort((a, b) => b.count - a.count)
                .map(item => item.result);

            sortedResults.forEach(result => {
                html += `<div class="stats-item type"><span>${getResultDisplay(result)}:</span> <span class="stats-count">${resultCounts[result]}</span></div>`;
            });

            statsContent.innerHTML = html;
        }

        function setupVisibilityListener() {
            let boundsChangeTimeout;

            myMap.events.add('boundschange', function() {
                clearTimeout(boundsChangeTimeout);
                boundsChangeTimeout = setTimeout(updateVisibleStatistics, 300);
            });

            let zoomTimeout;
            myMap.events.add('zoomend', function() {
                clearTimeout(zoomTimeout);
                zoomTimeout = setTimeout(updateVisibleStatistics, 300);
            });

            let moveTimeout;
            myMap.events.add('moveend', function() {
                clearTimeout(moveTimeout);
                moveTimeout = setTimeout(updateVisibleStatistics, 300);
            });
        }




        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'info') {
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'info' ? '#3399ff' : type === 'success' ? '#00cc66' : type === 'warning' ? '#ff9900' : '#ff3333'};
                color: white;
                padding: 15px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 2000;
                font-size: 14px;
                font-weight: bold;
                animation: slideIn 0.3s ease;
                border: 1px solid ${type === 'info' ? '#0066cc' : type === 'success' ? '#00994d' : type === 'warning' ? '#cc7a00' : '#cc0000'};
            `;

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(notification);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.5s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 3000);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        function init() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...');
            document.getElementById('loading').style.display = 'none';

            myMap = new ymaps.Map("map", {
                center: [55.7558, 37.6176],
                zoom: 3,
                type: 'yandex#hybrid',
                controls: ['zoomControl', 'typeSelector', 'fullscreenControl']
            });

            objectManager = new ymaps.ObjectManager({
                clusterize: true,
                gridSize: 64,
                clusterDisableClickZoom: false
            });

            objectManager.clusters.options.set({
                preset: 'islands#invertedRedClusterIcons'
            });

            myMap.geoObjects.add(objectManager);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–µ—Ç—ã
            loadFlights();
        }





        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–µ—Ç–æ–≤ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function loadFlights() {
            if (isUpdating) {
                console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
                return;
            }

            isUpdating = true;
            console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø–æ–ª–µ—Ç–æ–≤...');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            showUpdateIndicator(true);

            fetch('/api/flights/')
                .then(response => {
                    console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª–µ—Ç–æ–≤:', data.length);
                    if (data.length > 0) {
                        console.log('–ü–µ—Ä–≤—ã–π –ø–æ–ª–µ—Ç (–ø—Ä–∏–º–µ—Ä):', data[0]);
                        console.log('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª–µ—Ç–∞:', data[0]?.coordinates_info);
                        console.log('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª–µ—Ç–∞ (lat_wgs84, lon_wgs84):', 
                            data[0]?.coordinates_info?.lat_wgs84, 
                            data[0]?.coordinates_info?.lon_wgs84);
                    } else {
                        console.warn('‚ö†Ô∏è API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø–æ–ª–µ—Ç–æ–≤!');
                    }

                    allFlights = data;
                    filteredFlights = [...data];

                    console.log('–í—Å–µ–≥–æ –ø–æ–ª–µ—Ç–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏:', allFlights.length);
                    console.log('–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ–ª–µ—Ç–æ–≤:', filteredFlights.length);

                    collectFilterValues();
                    populateFilterDropdowns();
                    updateFlightsOnMap();
                    updateVisibleStatistics();


                    setTimeout(() => {
                        showUpdateIndicator(false);
                        isUpdating = false;
                    }, 1000);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–µ—Ç–æ–≤:', error);
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');

                    setTimeout(() => {
                        showUpdateIndicator(false);
                        isUpdating = false;
                    }, 1000);
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function showUpdateIndicator(show) {
            const indicator = document.getElementById('updateIndicator');
            if (indicator) {
                if (show) {
                    indicator.style.display = 'block';
                } else {
                    indicator.style.display = 'none';
                }
            }
        }



        function mapLoadError() {
            document.getElementById('loading').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
            console.error('Failed to load Yandex Maps API');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadYandexMap);
        } else {
            loadYandexMap();
        }

        // –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            const mobileMenu = document.getElementById('mobile-menu');
            const navLinks = document.querySelector('.nav-links');

            // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞
            const sidebar = document.querySelector('.sidebar');
            const mobileFilterToggle = document.getElementById('mobileFilterToggle');

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
            if (mobileMenu && navLinks) {
                mobileMenu.addEventListener('click', function() {
                    mobileMenu.classList.toggle('active');
                    navLinks.classList.toggle('active');
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Å—ã–ª–∫—É
                const navItems = navLinks.querySelectorAll('a');
                navItems.forEach(item => {
                    item.addEventListener('click', () => {
                        mobileMenu.classList.remove('active');
                        navLinks.classList.remove('active');
                    });
                });
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
            if (mobileFilterToggle && sidebar) {
                mobileFilterToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –∏–ª–∏ —Å–±—Ä–æ—Å–µ
            const applyBtn = document.querySelector('.apply-btn');
            const resetBtn = document.querySelector('.reset-btn');

            if (applyBtn) {
                applyBtn.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                });
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                });
            }
        });

        // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç GPX –¥–ª—è AlpineQuest
        function exportToAlpineQuest() {
            if (!filteredFlights || filteredFlights.length === 0) {
                alert('–ù–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º GPX —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            let gpxContent = '<?xml version="1.0" encoding="UTF-8"?>\n';
            gpxContent += '<gpx version="1.1" creator="Rubicon Bot" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">\n';
            gpxContent += '  <metadata>\n';
            gpxContent += `    <name>–≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª–µ—Ç–æ–≤ ${new Date().toISOString().split('T')[0]}</name>\n`;
            gpxContent += `    <desc>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${filteredFlights.length} —Ç–æ—á–µ–∫</desc>\n`;
            gpxContent += '  </metadata>\n';

            let waypointCount = 0;
            filteredFlights.forEach((flight, index) => {
                if (!flight.coordinates_info) {
                    return;
                }

                const coord = flight.coordinates_info;
                const lat = coord.lat_wgs84;
                const lon = coord.lon_wgs84;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                if (lat === null || lon === null || isNaN(lat) || isNaN(lon)) {
                    return;
                }

                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                if (lat === 90.0 && lon === 0.0) {
                    return;
                }

                waypointCount++;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏–∫–æ–Ω–∫–∏ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                let symbol = 'Flag, Blue';
                if (flight.result === 'destroyed') {
                    symbol = 'Flag, Red';
                } else if (flight.result === 'defeated') {
                    symbol = 'Flag, Orange';
                } else if (flight.result === 'not defeated') {
                    symbol = 'Flag, Gray';
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ—á–∫–∏
                let description = `–ü–æ–ª–µ—Ç ‚Ññ${flight.number || 'N/A'}`;
                if (flight.pilot_name) {
                    description += `\\n–ü–∏–ª–æ—Ç: ${flight.pilot_name}`;
                }
                if (flight.target) {
                    description += `\\n–¶–µ–ª—å: ${flight.target}`;
                }
                if (flight.drone) {
                    description += `\\n–î—Ä–æ–Ω: ${flight.drone}`;
                }
                if (flight.flight_date) {
                    description += `\\n–î–∞—Ç–∞: ${flight.flight_date}`;
                }
                if (flight.flight_time) {
                    description += `\\n–í—Ä–µ–º—è: ${flight.flight_time}`;
                }
                if (flight.result) {
                    const resultText = {
                        'destroyed': '–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ',
                        'defeated': '–ü–æ—Ä–∞–∂–µ–Ω–æ',
                        'not defeated': '–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ'
                    }[flight.result] || flight.result;
                    description += `\\n–†–µ–∑—É–ª—å—Ç–∞—Ç: ${resultText}`;
                }
                if (flight.comment) {
                    description += `\\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${flight.comment}`;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º waypoint
                gpxContent += '  <wpt lat="' + lat + '" lon="' + lon + '">\n';
                gpxContent += '    <name>–ü–æ–ª–µ—Ç ' + (flight.number || index + 1) + '</name>\n';
                gpxContent += '    <desc><![CDATA[' + description + ']]></desc>\n';
                gpxContent += '    <sym>' + symbol + '</sym>\n';
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è AlpineQuest
                if (flight.coordinates) {
                    gpxContent += '    <extensions>\n';
                    gpxContent += '      <coordinates_sk42>' + flight.coordinates + '</coordinates_sk42>\n';
                    gpxContent += '    </extensions>\n';
                }
                
                gpxContent += '  </wpt>\n';
            });

            gpxContent += '</gpx>';

            if (waypointCount === 0) {
                alert('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const blob = new Blob([gpxContent], { type: 'application/gpx+xml;charset=utf-8' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `flights_export_${new Date().toISOString().split('T')[0]}.gpx`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${waypointCount} —Ç–æ—á–µ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ GPX`, 'success');
        }

        // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç CSV
        function exportToCSV() {
            if (!filteredFlights || filteredFlights.length === 0) {
                showNotification('–ù–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ CSV
            let csvContent = '\uFEFF'; // BOM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ Excel
            csvContent += '–ù–æ–º–µ—Ä –≤—ã–ª–µ—Ç–∞,–ü–∏–ª–æ—Ç,–î—Ä–æ–Ω,–î–∞—Ç–∞,–í—Ä–µ–º—è,–¢–∏–ø —Ü–µ–ª–∏,–†–µ–∑—É–ª—å—Ç–∞—Ç,–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –°–ö-42,–®–∏—Ä–æ—Ç–∞ WGS84,–î–æ–ª–≥–æ—Ç–∞ WGS84,–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π\n';

            let exportedCount = 0;
            filteredFlights.forEach((flight) => {
                if (!flight.coordinates_info) {
                    return;
                }

                const coord = flight.coordinates_info;
                const lat = coord.lat_wgs84;
                const lon = coord.lon_wgs84;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                if (lat === null || lon === null || isNaN(lat) || isNaN(lon)) {
                    return;
                }

                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                if (lat === 90.0 && lon === 0.0) {
                    return;
                }

                exportedCount++;

                // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è CSV
                const escapeCSV = (value) => {
                    if (value === null || value === undefined) return '';
                    const str = String(value);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                };

                const resultText = {
                    'destroyed': '–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ',
                    'defeated': '–ü–æ—Ä–∞–∂–µ–Ω–æ',
                    'not defeated': '–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ'
                }[flight.result] || flight.result || '';

                csvContent += [
                    escapeCSV(flight.number || ''),
                    escapeCSV(flight.pilot_name || ''),
                    escapeCSV(flight.drone || ''),
                    escapeCSV(flight.flight_date || ''),
                    escapeCSV(flight.flight_time || ''),
                    escapeCSV(flight.target || ''),
                    escapeCSV(resultText),
                    escapeCSV(flight.coordinates || ''),
                    escapeCSV(lat),
                    escapeCSV(lon),
                    escapeCSV(flight.comment || '')
                ].join(',') + '\n';
            });

            if (exportedCount === 0) {
                showNotification('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            link.setAttribute('download', `flights_export_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showNotification(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${exportedCount} —Ç–æ—á–µ–∫ –≤ CSV —Ñ–∞–π–ª`, 'success');
        }

        // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç KML –¥–ª—è Google Earth
        function exportToKML() {
            if (!filteredFlights || filteredFlights.length === 0) {
                showNotification('–ù–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º KML —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            let kmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n';
            kmlContent += '<kml xmlns="http://www.opengis.net/kml/2.2">\n';
            kmlContent += '  <Document>\n';
            kmlContent += `    <name>–≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª–µ—Ç–æ–≤ ${new Date().toISOString().split('T')[0]}</name>\n`;
            kmlContent += `    <description>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${filteredFlights.length} —Ç–æ—á–µ–∫</description>\n`;

            // –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            kmlContent += '    <Style id="destroyed">\n';
            kmlContent += '      <IconStyle>\n';
            kmlContent += '        <color>ff0000ff</color>\n';
            kmlContent += '        <scale>1.2</scale>\n';
            kmlContent += '        <Icon><href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href></Icon>\n';
            kmlContent += '      </IconStyle>\n';
            kmlContent += '    </Style>\n';

            kmlContent += '    <Style id="defeated">\n';
            kmlContent += '      <IconStyle>\n';
            kmlContent += '        <color>ff0099ff</color>\n';
            kmlContent += '        <scale>1.1</scale>\n';
            kmlContent += '        <Icon><href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href></Icon>\n';
            kmlContent += '      </IconStyle>\n';
            kmlContent += '    </Style>\n';

            kmlContent += '    <Style id="not_defeated">\n';
            kmlContent += '      <IconStyle>\n';
            kmlContent += '        <color>ff808080</color>\n';
            kmlContent += '        <scale>1.0</scale>\n';
            kmlContent += '        <Icon><href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href></Icon>\n';
            kmlContent += '      </IconStyle>\n';
            kmlContent += '    </Style>\n';

            let placemarkCount = 0;
            filteredFlights.forEach((flight, index) => {
                if (!flight.coordinates_info) {
                    return;
                }

                const coord = flight.coordinates_info;
                const lat = coord.lat_wgs84;
                const lon = coord.lon_wgs84;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                if (lat === null || lon === null || isNaN(lat) || isNaN(lon)) {
                    return;
                }

                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                if (lat === 90.0 && lon === 0.0) {
                    return;
                }

                placemarkCount++;

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª—å –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                let styleUrl = '#not_defeated';
                if (flight.result === 'destroyed') {
                    styleUrl = '#destroyed';
                } else if (flight.result === 'defeated') {
                    styleUrl = '#defeated';
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
                let description = '<![CDATA[<table border="1" cellpadding="3" cellspacing="0" style="font-family: Arial; font-size: 12px;">';
                description += `<tr><td><b>–ù–æ–º–µ—Ä –≤—ã–ª–µ—Ç–∞:</b></td><td>${flight.number || 'N/A'}</td></tr>`;
                if (flight.pilot_name) {
                    description += `<tr><td><b>–ü–∏–ª–æ—Ç:</b></td><td>${flight.pilot_name}</td></tr>`;
                }
                if (flight.drone) {
                    description += `<tr><td><b>–î—Ä–æ–Ω:</b></td><td>${flight.drone}</td></tr>`;
                }
                if (flight.flight_date) {
                    description += `<tr><td><b>–î–∞—Ç–∞:</b></td><td>${flight.flight_date}</td></tr>`;
                }
                if (flight.flight_time) {
                    description += `<tr><td><b>–í—Ä–µ–º—è:</b></td><td>${flight.flight_time}</td></tr>`;
                }
                if (flight.target) {
                    description += `<tr><td><b>–¢–∏–ø —Ü–µ–ª–∏:</b></td><td>${flight.target}</td></tr>`;
                }
                if (flight.result) {
                    const resultText = {
                        'destroyed': '–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ',
                        'defeated': '–ü–æ—Ä–∞–∂–µ–Ω–æ',
                        'not defeated': '–ù–µ –ø–æ—Ä–∞–∂–µ–Ω–æ'
                    }[flight.result] || flight.result;
                    description += `<tr><td><b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b></td><td>${resultText}</td></tr>`;
                }
                if (flight.coordinates) {
                    description += `<tr><td><b>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –°–ö-42:</b></td><td>${flight.coordinates}</td></tr>`;
                }
                if (flight.comment) {
                    description += `<tr><td><b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b></td><td>${flight.comment}</td></tr>`;
                }
                description += '</table>]]>';

                // –î–æ–±–∞–≤–ª—è–µ–º Placemark
                kmlContent += '    <Placemark>\n';
                kmlContent += `      <name>–ü–æ–ª–µ—Ç ${flight.number || index + 1}</name>\n`;
                kmlContent += `      <description>${description}</description>\n`;
                kmlContent += `      <styleUrl>${styleUrl}</styleUrl>\n`;
                kmlContent += '      <Point>\n';
                kmlContent += `        <coordinates>${lon},${lat},0</coordinates>\n`;
                kmlContent += '      </Point>\n';
                kmlContent += '    </Placemark>\n';
            });

            kmlContent += '  </Document>\n';
            kmlContent += '</kml>';

            if (placemarkCount === 0) {
                showNotification('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            link.setAttribute('download', `flights_export_${dateStr}.kml`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showNotification(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${placemarkCount} —Ç–æ—á–µ–∫ –≤ KML —Ñ–∞–π–ª`, 'success');
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
        window.addEventListener('resize', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            const navLinks = document.querySelector('.nav-links');
            const sidebar = document.querySelector('.sidebar');

            if (window.innerWidth > 768) {
                if (mobileMenu && navLinks) {
                    mobileMenu.classList.remove('active');
                    navLinks.classList.remove('active');
                }
                if (sidebar) {
                    sidebar.classList.remove('active');
                }
            }
        });
    </script>
</body>
</html>